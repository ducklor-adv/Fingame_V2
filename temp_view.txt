<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Fingrow - Finpoint Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Use CDN UMD bundles (jsDelivr) to avoid local 404/CORS issues -->
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.5/babel.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    input, select, textarea { font-size: 16px !important; }
    html { scroll-behavior: smooth; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Bottom nav safe area for iOS */
    .bottom-nav-safe {
      padding-bottom: env(safe-area-inset-bottom);
    }
  </style>
</head>
<body class="bg-slate-950">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // API Configuration
    const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:3001' : '';

    // Mock User (fallback for demo)
    const mockUser = {
      id: "4d003630-3ed6-4d80-89fd-5c1d2f017be1",
      worldId: "25AAA0001",
      username: "somchai_jaidee",
      firstName: "α╕¬α╕íα╕èα╕▓α╕ó",
      lastName: "α╣âα╕êα╕öα╕╡",
      firstName: "α╕¬α╕íα╕èα╕▓α╕ó",
      lastName: "α╣âα╕êα╕öα╕╡",
      email: "somchai@fingrow.com",
      phone: "0812345678",
      avatarUrl: null,
      bio: "α╕£α╕╣α╣ëα╣âα╕èα╣ëα╕çα╕▓α╕Öα╕ùα╕öα╕¬α╕¡α╕Üα╕úα╕░α╕Üα╕Ü Fingrow",
      isVerified: true,
      verificationLevel: 3,
      trustScore: 95.5,
      totalSales: 152,
      totalPurchases: 89,
      runNumber: 1,
      level: 1,
      childCount: 3,
      maxChildren: 5,
      acfAccepting: true,
      inviterUsername: "system_root",
      inviteCode: "DEMO2025",
      ownFinpoint: 3250,
      totalFinpoint: 12500,
      maxNetwork: 19531,
      addressNumber: "123/45",
      addressStreet: "α╕ûα╕Öα╕Öα╕¬α╕╕α╕éα╕╕α╕íα╕ºα╕┤α╕ù",
      addressSubDistrict: "α╕äα╕Ñα╕¡α╕çα╣Çα╕òα╕ó",
      addressDistrict: "α╕äα╕Ñα╕¡α╕çα╣Çα╕òα╕ó",
      addressProvince: "α╕üα╕úα╕╕α╕çα╣Çα╕ùα╕₧α╕íα╕½α╕▓α╕Öα╕äα╕ú",
      addressPostalCode: "10110",
    };

    const mockDashboardData = {
      currentFpBalance: 3250,
      lastUpdated: "23/11/2025 14:32",
      todayEarned: 120,
      todayFromSecondhand: 80,
      todayFromUpline: 40,
      expProgressList: [
        { code: "LEVEL_1", label: "Level 1 ΓÇô α╕₧α╕úα╕Ü.", target: 600, current: 420 },
        { code: "LEVEL_2", label: "Level 2 ΓÇô α╕¢α╕úα╕░α╕üα╕▒α╕Öα╕áα╕▒α╕óα╕úα╕û", target: 5000, current: 1350 },
        { code: "LEVEL_3", label: "Level 3 ΓÇô α╕¢α╕úα╕░α╕üα╕▒α╕Öα╕¬α╕╕α╕éα╕áα╕▓α╕₧", target: 20000, current: 2500 },
        { code: "LEVEL_4", label: "Level 4 ΓÇô α╕¢α╕úα╕░α╕üα╕▒α╕Öα╕èα╕╡α╕ºα╕┤α╕ò", target: 50000, current: 0 },
      ],
      recentLedger: [
        { id: 1, datetime: "23/11 14:10", category: "α╕éα╕▓α╕óα╕éα╕¡α╕çα╕íα╕╖α╕¡α╕¬α╕¡α╕ç", detail: "#S-1021", drCr: "DR", amount: 70, balanceAfter: 3250 },
        { id: 2, datetime: "23/11 09:00", category: "α╕₧α╕úα╕Ü. α╕äα╕╖α╕Öα╣Çα╕çα╕┤α╕Ö", detail: "Self 45%", drCr: "DR", amount: 30, balanceAfter: 3180 },
        { id: 3, datetime: "22/11 18:30", category: "Network Bonus", detail: "α╕êα╕▓α╕ü downline", drCr: "DR", amount: 15, balanceAfter: 3150 },
        { id: 4, datetime: "22/11 10:15", category: "α╕éα╕▓α╕óα╕éα╕¡α╕çα╕íα╕╖α╕¡α╕¬α╕¡α╕ç", detail: "#S-1015", drCr: "DR", amount: 55, balanceAfter: 3135 },
        { id: 5, datetime: "21/11 16:20", category: "α╕ïα╕╖α╣ëα╕¡α╕¢α╕úα╕░α╕üα╕▒α╕Öα╕¬α╕╕α╕éα╕áα╕▓α╕₧", detail: "#E-450", drCr: "CR", amount: 200, balanceAfter: 3080 },
      ],
      networkSnapshot: {
        networkSize: 1235,
        fpFromYou: 120,
        uplinePath: [
          { id: "25AAA0001", name: "α╕¬α╕íα╕èα╕▓α╕ó α╣âα╕êα╕öα╕╡", worldId: "25AAA0001" },
          { id: "25AAA0015", name: "α╕¬α╕íα╕½α╕ìα╕┤α╕ç α╕úα╕▒α╕üα╕öα╕╡", worldId: "25AAA0015" },
          { id: "25AAA0032", name: "α╕¬α╕íα╕¿α╕▒α╕üα╕öα╕┤α╣î α╕íα╕▒α╣êα╕çα╕äα╕▒α╣êα╕ç", worldId: "25AAA0032" },
          { id: "25AAA0087", name: "α╕¬α╕íα╕₧α╕ú α╕¬α╕╕α╕éα╣âα╕ê", worldId: "25AAA0087" },
          { id: "25AAA0120", name: "α╕ºα╕┤α╕èα╕▒α╕ó α╣Çα╕êα╕úα╕┤α╕ì", worldId: "25AAA0120" },
          { id: "25AAA0230", name: "α╕¢α╕úα╕░α╕óα╕╕α╕ùα╕ÿ α╕öα╕╡α╕çα╕▓α╕í", worldId: "25AAA0230" },
          { id: "25AAA0000", name: "SYSTEM ROOT", worldId: "25AAA0000" },
        ],
      },
    };

    // Main App Component
    function App() {
      const [currentPage, setCurrentPage] = useState('home');
      const [userData, setUserData] = useState(null);
      const [dashboardData, setDashboardData] = useState(null);
      const [isLoading, setIsLoading] = useState(true);
      const [isLoggedIn, setIsLoggedIn] = useState(false);
      const [unreadNotificationCount, setUnreadNotificationCount] = useState(0);
      const [notificationReadIds, setNotificationReadIds] = useState([]);

      // Fetch data from API
      const fetchUserData = async () => {
        try {
          setIsLoading(true);
          // Get user ID from localStorage or use mock
          const userId = localStorage.getItem('userId') || mockUser.id;

          // Fetch user data
          const userResponse = await fetch(`${API_BASE}/api/users/${userId}`);
          if (userResponse.ok) {
            const user = await userResponse.json();
            setUserData(user);
          } else {
            // Fallback to mock data
            setUserData(mockUser);
          }

          // Fetch ALL dashboard data including insurance levels
          const finpointResponse = await fetch(`${API_BASE}/api/finpoint/${userId}/balance`);
          const transactionsResponse = await fetch(`${API_BASE}/api/finpoint/${userId}/transactions?limit=20`);
          const todayResponse = await fetch(`${API_BASE}/api/finpoint/${userId}/today`);
          const networkResponse = await fetch(`${API_BASE}/api/network/${userId}/summary`);
          const insuranceResponse = await fetch(`${API_BASE}/api/insurance/${userId}/levels`);

          if (finpointResponse.ok && transactionsResponse.ok && todayResponse.ok && networkResponse.ok && insuranceResponse.ok) {
            const [finpoint, transactions, today, network, insurance] = await Promise.all([
              finpointResponse.json(),
              transactionsResponse.json(),
              todayResponse.json(),
              networkResponse.json(),
              insuranceResponse.json()
            ]);

            setDashboardData({
              currentFpBalance: finpoint.currentBalance || 0,
              lastUpdated: new Date().toLocaleString('th-TH'),
              todayEarned: today.totalEarned || 0,
              todayFromSecondhand: today.fromSecondhand || 0,
              todayFromUpline: today.fromUpline || 0,
              expProgressList: insurance.levels || [],
              recentLedger: transactions.transactions || [],
              networkSnapshot: network.snapshot || {
                networkSize: 0,
                fpFromYou: 0,
                uplinePath: []
              }
            });
          } else {
            console.error('API Error - Some endpoints failed');
            setUserData(mockUser);
            setDashboardData(mockDashboardData);
          }
        } catch (error) {
          console.error('Error fetching data:', error);
          // Fallback to mock data
          setUserData(mockUser);
          setDashboardData(mockDashboardData);
        } finally {
          setIsLoading(false);
        }
      };

      // Fetch data on mount
      useEffect(() => {
        // Check if user is logged in
        const storedUserId = localStorage.getItem('userId');
        const storedWorldId = localStorage.getItem('worldId');

        if (storedUserId || storedWorldId) {
          setIsLoggedIn(true);
          fetchUserData();
        } else {
          setIsLoading(false);
          setIsLoggedIn(false);
        }
      }, []);

      // Load read notification ids from localStorage when user changes
      useEffect(() => {
        if (userData?.id) {
          const saved = localStorage.getItem(`notifReadIds_${userData.id}`);
          try {
            const parsed = saved ? JSON.parse(saved) : [];
            setNotificationReadIds(Array.isArray(parsed) ? parsed : []);
          } catch (e) {
            setNotificationReadIds([]);
          }
        } else {
          setNotificationReadIds([]);
          setUnreadNotificationCount(0);
        }
      }, [userData?.id]);

      // Background fetch to update unread count (evenα╣Çα╕íα╕╖α╣êα╕¡α╣äα╕íα╣êα╣äα╕öα╣ëα╣Çα╕¢α╕┤α╕öα╣üα╕ùα╣çα╕Üα╣üα╕êα╣ëα╕çα╣Çα╕òα╕╖α╕¡α╕Ö)
      useEffect(() => {
        let isMounted = true;
        const fetchNotifications = async () => {
          if (!userData?.id) return;
          try {
            const res = await fetch(`${API_BASE}/api/users/${userData.id}/notifications`);
            if (res.ok) {
              const data = await res.json();
              const list = data.notifications || [];
              const unread = list.filter(n => !notificationReadIds.includes(n.id)).length;
              if (isMounted) setUnreadNotificationCount(unread);
            }
          } catch (e) {
            // ignore background errors
          }
        };
        fetchNotifications();

        const interval = setInterval(fetchNotifications, 30000); // poll α╕ùα╕╕α╕ü 30 α╕ºα╕┤
        return () => {
          isMounted = false;
          clearInterval(interval);
        };
      }, [userData?.id, notificationReadIds]);

      // Show login page if not logged in
      if (!isLoggedIn && !isLoading) {
        return <LoginPage onLogin={(userId, worldId) => {
          localStorage.setItem('userId', userId);
          localStorage.setItem('worldId', worldId);
          setIsLoggedIn(true);
          fetchUserData();
        }} />;
      }

      if (isLoading) {
        return (
          <div className="min-h-screen bg-slate-950 text-slate-100 flex items-center justify-center">
            <div className="text-center">
              <div className="text-4xl mb-4">≡ƒÆÄ</div>
              <div className="text-lg font-semibold">α╕üα╕│α╕Ñα╕▒α╕çα╣éα╕½α╕Ñα╕öα╕éα╣ëα╕¡α╕íα╕╣α╕Ñ...</div>
              <div className="text-sm text-slate-400 mt-2">Fingrow Dashboard</div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-slate-950 text-slate-100 pb-16">
          {/* Content */}
          {currentPage === 'home' && <HomePage data={dashboardData} user={userData} onRefresh={fetchUserData} setDashboardData={setDashboardData} />}
          {currentPage === 'transactions' && <TransactionsPage data={dashboardData} user={userData} />}
          {currentPage === 'tree' && <TreePage user={userData} />}
          {currentPage === 'acf' && <ACFPage user={userData} />}
          {currentPage === 'database' && <DatabaseViewer />}
          {currentPage === 'notifications' && (
            <NotificationsPage
              user={userData}
              readIds={notificationReadIds}
              setReadIds={setNotificationReadIds}
              setUnreadNotificationCount={setUnreadNotificationCount}
              isActive
            />
          )}
          {currentPage === 'profile' && <ProfilePage user={userData} setUser={setUserData} onLogout={() => {
            localStorage.removeItem('userId');
            localStorage.removeItem('worldId');
            setIsLoggedIn(false);
            setUserData(null);
            setDashboardData(null);
          }} />}

          {/* Bottom Navigation */}
          <BottomNav
            currentPage={currentPage}
            setCurrentPage={setCurrentPage}
            unreadNotificationCount={unreadNotificationCount}
          />
        </div>
      );
    }

    // Login Page
    function LoginPage({ onLogin }) {
      const [loginMode, setLoginMode] = useState('quick'); // 'quick', 'credential', or 'register'
      const [worldId, setWorldId] = useState('');
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [error, setError] = useState('');
      const [referralCode, setReferralCode] = useState('');
      const [inviterInfo, setInviterInfo] = useState(null);
      const [loadingInviter, setLoadingInviter] = useState(false);

      // Get referral code from URL on mount
      useEffect(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const refParam = urlParams.get('ref');
        if (refParam) {
          setReferralCode(refParam);
          setLoginMode('register'); // Auto-switch to register tab
        }
      }, []);

      // Fetch inviter info when referral code changes
      useEffect(() => {
        if (referralCode && loginMode === 'register') {
          const fetchInviterInfo = async () => {
            setLoadingInviter(true);
            try {
              // Use invite_code referral lookup only
              const response = await fetch(`${API_BASE}/api/users/referral/${referralCode}`);

              if (response.ok) {
                const user = await response.json();
                setInviterInfo({
                  worldId: user.worldId,
                  username: user.username,
                  firstName: user.firstName,
                  lastName: user.lastName,
                  avatarUrl: user.avatarUrl
                });
              } else {
                setInviterInfo(null);
              }
            } catch (err) {
              console.error('Error fetching inviter info:', err);
              setInviterInfo(null);
            } finally {
              setLoadingInviter(false);
            }
          };

          fetchInviterInfo();
        } else {
          setInviterInfo(null);
        }
      }, [referralCode, loginMode]);

      const handleQuickLogin = async (testWorldId) => {
        setIsLoading(true);
        setError('');
        try {
          const response = await fetch(`${API_BASE}/api/users/world/${testWorldId}`);
          if (response.ok) {
            const user = await response.json();
            onLogin(user.id, user.worldId);
          } else {
            setError('α╣äα╕íα╣êα╕₧α╕Üα╕£α╕╣α╣ëα╣âα╕èα╣ë');
          }
        } catch (err) {
          setError('α╣Çα╕üα╕┤α╕öα╕éα╣ëα╕¡α╕£α╕┤α╕öα╕₧α╕Ñα╕▓α╕ö: ' + err.message);
        } finally {
          setIsLoading(false);
        }
      };

      const handleCredentialLogin = async (e) => {
        e.preventDefault();
        if (!username.trim() || !password.trim()) {
          setError('α╕üα╕úα╕╕α╕ôα╕▓α╣âα╕¬α╣ê Username α╣üα╕Ñα╕░ Password');
          return;
        }

        setIsLoading(true);
        setError('');
        try {
          // Simple credential check (in production, this should be server-side)
          if (username === 'system_root' && password === 'system_root') {
            // Login as system root
            const response = await fetch(`${API_BASE}/api/users/world/25AAA0000`);
            if (response.ok) {
              const user = await response.json();
              onLogin(user.id, user.worldId);
            } else {
              setError('α╣äα╕íα╣êα╕₧α╕Üα╕£α╕╣α╣ëα╣âα╕èα╣ë System Root');
            }
          } else {
            // Try to find user by username
            const response = await fetch(`${API_BASE}/api/users/username/${username}`);
            if (response.ok) {
              const user = await response.json();
              // In production, verify password on server
              onLogin(user.id, user.worldId);
            } else {
              setError('α╕èα╕╖α╣êα╕¡α╕£α╕╣α╣ëα╣âα╕èα╣ëα╕½α╕úα╕╖α╕¡α╕úα╕½α╕▒α╕¬α╕£α╣êα╕▓α╕Öα╣äα╕íα╣êα╕ûα╕╣α╕üα╕òα╣ëα╕¡α╕ç');
            }
          }
        } catch (err) {
          setError('α╣Çα╕üα╕┤α╕öα╕éα╣ëα╕¡α╕£α╕┤α╕öα╕₧α╕Ñα╕▓α╕ö: ' + err.message);
        } finally {
          setIsLoading(false);
        }
      };

      const handleWorldIdLogin = async (e) => {
        e.preventDefault();
        if (!worldId.trim()) {
          setError('α╕üα╕úα╕╕α╕ôα╕▓α╣âα╕¬α╣ê World ID');
          return;
        }
        handleQuickLogin(worldId.trim());
      };

      const handleGoogleSignIn = async (googleUser) => {
        setIsLoading(true);
        setError('');
        try {
          // Get Google user info from credential
          const credential = googleUser.credential;
          const payload = JSON.parse(atob(credential.split('.')[1]));

          console.log('Google User:', payload);

          // Create new user with Google info
          const response = await fetch(`${API_BASE}/api/users/google-signin`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              googleId: payload.sub,
              email: payload.email,
              firstName: payload.given_name || 'User',
              lastName: payload.family_name || '',
              avatarUrl: payload.picture,
              referralCode: referralCode || null // Send referral code if available
            })
          });

          if (response.ok) {
            const user = await response.json();
            onLogin(user.id, user.worldId);
          } else {
            const errorData = await response.json();
            setError(errorData.error || 'α╣Çα╕üα╕┤α╕öα╕éα╣ëα╕¡α╕£α╕┤α╕öα╕₧α╕Ñα╕▓α╕öα╣âα╕Öα╕üα╕▓α╕úα╕¬α╕íα╕▒α╕äα╕úα╕¬α╕íα╕▓α╕èα╕┤α╕ü');
          }
        } catch (err) {
          console.error('Google Sign-In Error:', err);
          setError('α╣Çα╕üα╕┤α╕öα╕éα╣ëα╕¡α╕£α╕┤α╕öα╕₧α╕Ñα╕▓α╕ö: ' + err.message);
        } finally {
          setIsLoading(false);
        }
      };

      // Initialize Google Sign-In when register tab is active
      useEffect(() => {
        if (loginMode === 'register') {
          // Wait for Google script to load
          const initializeGoogleSignIn = () => {
            if (window.google) {
              try {
                window.google.accounts.id.initialize({
                  client_id: '462949505309-kmjt5u6rqshqk1n90cte2v2a7fme3s23.apps.googleusercontent.com',
                  callback: handleGoogleSignIn,
                  auto_select: false
                });

                // Render the button
                const buttonDiv = document.getElementById('google-signin-button');
                if (buttonDiv) {
                  window.google.accounts.id.renderButton(buttonDiv, {
                    theme: 'outline',
                    size: 'large',
                    text: 'signup_with',
                    width: 350
                  });
                }
                setError(''); // Clear any loading errors
              } catch (err) {
                console.error('Google Sign-In initialization error:', err);
                setError('α╣äα╕íα╣êα╕¬α╕▓α╕íα╕▓α╕úα╕ûα╣éα╕½α╕Ñα╕ö Google Sign-In α╣äα╕öα╣ë α╕üα╕úα╕╕α╕ôα╕▓α╕òα╕úα╕ºα╕êα╕¬α╕¡α╕Ü Client ID');
              }
            } else {
              // Google script not loaded yet, retry after delay
              setTimeout(initializeGoogleSignIn, 500);
            }
          };

          initializeGoogleSignIn();
        }
      }, [loginMode]);

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-slate-100 flex items-center justify-center p-4">
          <div className="w-full max-w-md">
            {/* Logo */}
            <div className="text-center mb-8">
              <div className="w-24 h-24 mx-auto mb-4 flex items-center justify-center overflow-hidden">
                <img src="/FinGrow_Logo_NOBG.png" alt="Fingrow" className="w-full h-full object-contain" />
              </div>
              <h1 className="text-3xl font-bold text-amber-300 drop-shadow-[0_0_10px_rgba(251,191,36,0.9)]">
                Fingrow
              </h1>
              <div className="text-emerald-200 font-semibold mt-1 drop-shadow-[0_0_8px_rgba(52,211,153,0.7)]">
                Simulation Version (α╕úα╕░α╕Üα╕Üα╕êα╕│α╕Ñα╕¡α╕ç)
              </div>
              <p className="text-amber-300 text-sm mt-2">α╕úα╕░α╕Üα╕Ü Automation α╕ùα╕╡α╣êα╕èα╣êα╕ºα╕óα╣Çα╕úα╕▓α╕½α╕íα╕╕α╕Öα╕äα╣êα╕▓α╣âα╕èα╣ëα╕êα╣êα╕▓α╕ó α╕üα╕Ñα╕▒α╕Üα╕íα╕▓α╣Çα╕¢α╣çα╕Öα╕úα╕▓α╕óα╣äα╕öα╣ë α╣üα╕Üα╕Üα╕ƒα╕┤α╕Öα╣å</p>
            </div>

            {/* Login Card */}
            <div className="bg-slate-900/60 border border-slate-800 rounded-2xl p-6 backdrop-blur-lg">
              <h2 className="text-xl font-semibold mb-6 text-center">α╣Çα╕éα╣ëα╕▓α╕¬α╕╣α╣êα╕úα╕░α╕Üα╕Ü</h2>

              {/* Login Mode Tabs */}
              <div className="flex gap-2 mb-6">
                <button
                  onClick={() => setLoginMode('quick')}
                  className={`flex-1 py-2 px-3 rounded-lg text-xs font-medium transition-colors ${
                    loginMode === 'quick'
                      ? 'bg-emerald-600 text-white'
                      : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                  }`}
                >
                  Quick Login
                </button>
                <button
                  onClick={() => setLoginMode('credential')}
                  className={`flex-1 py-2 px-3 rounded-lg text-xs font-medium transition-colors ${
                    loginMode === 'credential'
                      ? 'bg-emerald-600 text-white'
                      : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                  }`}
                >
                  Username/Password
                </button>
                <button
                  onClick={() => setLoginMode('register')}
                  className={`flex-1 py-2 px-3 rounded-lg text-xs font-medium transition-colors ${
                    loginMode === 'register'
                      ? 'bg-emerald-600 text-white'
                      : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                  }`}
                >
                  α╕¬α╕íα╕▒α╕äα╕úα╕¬α╕íα╕▓α╕èα╕┤α╕ü
                </button>
              </div>

              {/* Quick Login Mode */}
              {loginMode === 'quick' && (
                <>
                  {/* Admin/Root Login */}
                  <div className="mb-4">
                    <p className="text-sm text-slate-400 mb-3">≡ƒöæ α╕£α╕╣α╣ëα╕öα╕╣α╣üα╕Ñα╕úα╕░α╕Üα╕Ü:</p>
                    <button
                      onClick={() => handleQuickLogin('25AAA0000')}
                      disabled={isLoading}
                      className="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50 flex items-center justify-center gap-2"
                    >
                      <span>≡ƒææ</span>
                      <span>System Root (25AAA0000)</span>
                    </button>
                  </div>

                  {/* Divider */}
                  <div className="relative my-6">
                    <div className="absolute inset-0 flex items-center">
                      <div className="w-full border-t border-slate-700"></div>
                    </div>
                    <div className="relative flex justify-center text-xs uppercase">
                      <span className="bg-slate-900 px-2 text-slate-400">Test Users</span>
                    </div>
                  </div>

                  {/* Test Users Quick Login */}
                  <div className="space-y-3 mb-6">
                    <button
                      onClick={() => handleQuickLogin('25AAA0001')}
                      disabled={isLoading}
                      className="w-full px-4 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50"
                    >
                      ≡ƒºæ Somchai Jaidee (25AAA0001)
                    </button>
                    <button
                      onClick={() => handleQuickLogin('25AAA0002')}
                      disabled={isLoading}
                      className="w-full px-4 py-3 bg-teal-600 hover:bg-teal-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50"
                    >
                      ≡ƒæ⌐ Somsri Rakdee (25AAA0002)
                    </button>
                  </div>

                  {/* Divider */}
                  <div className="relative my-6">
                    <div className="absolute inset-0 flex items-center">
                      <div className="w-full border-t border-slate-700"></div>
                    </div>
                    <div className="relative flex justify-center text-xs uppercase">
                      <span className="bg-slate-900 px-2 text-slate-400">α╕½α╕úα╕╖α╕¡ World ID</span>
                    </div>
                  </div>

                  {/* World ID Login Form */}
                  <form onSubmit={handleWorldIdLogin} className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-slate-300 mb-2">
                        World ID
                      </label>
                      <input
                        type="text"
                        value={worldId}
                        onChange={(e) => setWorldId(e.target.value)}
                        placeholder="α╣Çα╕èα╣êα╕Ö 25AAA0001"
                        className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                      />
                    </div>

                    {error && (
                      <div className="px-4 py-3 bg-rose-900/20 border border-rose-500/50 rounded-lg text-rose-300 text-sm">
                        {error}
                      </div>
                    )}

                    <button
                      type="submit"
                      disabled={isLoading}
                      className="w-full px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-medium transition-colors disabled:opacity-50"
                    >
                      {isLoading ? 'α╕üα╕│α╕Ñα╕▒α╕çα╣Çα╕éα╣ëα╕▓α╕¬α╕╣α╣êα╕úα╕░α╕Üα╕Ü...' : 'α╣Çα╕éα╣ëα╕▓α╕¬α╕╣α╣êα╕úα╕░α╕Üα╕Ü'}
                    </button>
                  </form>
                </>
              )}

              {/* Credential Login Mode */}
              {loginMode === 'credential' && (
                <form onSubmit={handleCredentialLogin} className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-slate-300 mb-2">
                      Username
                    </label>
                    <input
                      type="text"
                      value={username}
                      onChange={(e) => setUsername(e.target.value)}
                      placeholder="system_root, somchai_jaidee, ..."
                      className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-slate-300 mb-2">
                      Password
                    </label>
                    <input
                      type="password"
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      placeholder="ΓÇóΓÇóΓÇóΓÇóΓÇóΓÇóΓÇóΓÇó"
                      className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                    />
                  </div>

                  {error && (
                    <div className="px-4 py-3 bg-rose-900/20 border border-rose-500/50 rounded-lg text-rose-300 text-sm">
                      {error}
                    </div>
                  )}

                  <button
                    type="submit"
                    disabled={isLoading}
                    className="w-full px-4 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50"
                  >
                    {isLoading ? 'α╕üα╕│α╕Ñα╕▒α╕çα╣Çα╕éα╣ëα╕▓α╕¬α╕╣α╣êα╕úα╕░α╕Üα╕Ü...' : 'α╣Çα╕éα╣ëα╕▓α╕¬α╕╣α╣êα╕úα╕░α╕Üα╕Ü'}
                  </button>

                  {/* Hint */}
                  <div className="text-xs text-slate-500 text-center">
                    ≡ƒÆí Admin: username = <code className="text-blue-400">system_root</code>, password = <code className="text-blue-400">system_root</code>
                  </div>
                </form>
              )}

              {/* Register Mode */}
              {loginMode === 'register' && (
                <div className="space-y-4">
                  <div className="text-center mb-6">
                    <h3 className="text-lg font-medium text-slate-200 mb-2">α╕¬α╕íα╕▒α╕äα╕úα╕¬α╕íα╕▓α╕èα╕┤α╕üα╕öα╣ëα╕ºα╕ó Google</h3>
                    <p className="text-sm text-slate-400">α╣Çα╕éα╣ëα╕▓α╕¬α╕╣α╣êα╕úα╕░α╕Üα╕Üα╕öα╣ëα╕ºα╕ó Google Account α╕éα╕¡α╕çα╕äα╕╕α╕ô</p>
                  </div>

                  {error && (
                    <div className="px-4 py-3 bg-rose-900/20 border border-rose-500/50 rounded-lg text-rose-300 text-sm">
                      {error}
                    </div>
                  )}

                  {/* Show inviter info if available */}
                  {referralCode && (
                    <div className="mt-4 p-4 bg-emerald-900/20 border border-emerald-500/50 rounded-lg">
                      <div className="text-emerald-300 text-sm text-center mb-3">
                        α╕úα╕½α╕▒α╕¬α╣üα╕Öα╕░α╕Öα╕│: <span className="font-bold">{referralCode}</span>
                      </div>

                      {loadingInviter ? (
                        <div className="text-center text-slate-400 text-xs">
                          α╕üα╕│α╕Ñα╕▒α╕çα╕òα╕úα╕ºα╕êα╕¬α╕¡α╕Üα╕£α╕╣α╣ëα╣üα╕Öα╕░α╕Öα╕│...
                        </div>
                      ) : inviterInfo ? (
                        <div className="flex items-center gap-3 bg-slate-800/50 rounded-lg p-3">
                          {/* Avatar */}
                          <div className="flex-shrink-0">
                            {inviterInfo.avatarUrl ? (
                              <img
                                src={inviterInfo.avatarUrl}
                                alt={inviterInfo.username}
                                className="w-12 h-12 rounded-full object-cover border-2 border-emerald-500"
                              />
                            ) : (
                              <div className="w-12 h-12 rounded-full bg-gradient-to-br from-emerald-400 to-teal-500 flex items-center justify-center text-white font-bold text-lg border-2 border-emerald-500">
                                {inviterInfo.firstName ? inviterInfo.firstName.charAt(0).toUpperCase() : '?'}
                              </div>
                            )}
                          </div>

                          {/* Info */}
                          <div className="flex-1 min-w-0">
                            <div className="text-white font-medium text-sm truncate">
                              {inviterInfo.firstName} {inviterInfo.lastName}
                            </div>
                            <div className="text-slate-400 text-xs truncate">
                              @{inviterInfo.username}
                            </div>
                            <div className="text-emerald-400 text-xs font-mono">
                              {inviterInfo.worldId}
                            </div>
                          </div>

                          {/* Check Icon */}
                          <div className="flex-shrink-0 text-emerald-400">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                          </div>
                        </div>
                      ) : (
                        <div className="text-center text-rose-400 text-xs">
                          α╣äα╕íα╣êα╕₧α╕Üα╕£α╕╣α╣ëα╣üα╕Öα╕░α╕Öα╕│α╣âα╕Öα╕úα╕░α╕Üα╕Ü
                        </div>
                      )}
                    </div>
                  )}

                  {/* Google Sign-In Button Placeholder (below inviter card) */}
                  <div id="google-signin-button" className="flex justify-center min-h-[44px]">
                    {/* Loading indicator will show until Google button renders */}
                    <div className="text-slate-400 text-sm">α╕üα╕│α╕Ñα╕▒α╕çα╣éα╕½α╕Ñα╕ö Google Sign-In...</div>
                  </div>

                  {/* Divider */}
                  <div className="relative my-6">
                    <div className="absolute inset-0 flex items-center">
                      <div className="w-full border-t border-slate-700"></div>
                    </div>
                    <div className="relative flex justify-center text-xs uppercase">
                      <span className="bg-slate-900 px-2 text-slate-400">α╕éα╣ëα╕¡α╕íα╕╣α╕Ñ</span>
                    </div>
                  </div>

                  <div className="text-xs text-slate-400 space-y-2">
                    <p>Γ£à α╣âα╕èα╣ëα╕éα╣ëα╕¡α╕íα╕╣α╕Ñ Google Account α╕éα╕¡α╕çα╕äα╕╕α╕ôα╣âα╕Öα╕üα╕▓α╕úα╕¬α╕íα╕▒α╕äα╕úα╕¬α╕íα╕▓α╕èα╕┤α╕ü</p>
                    <p>Γ£à α╕¢α╕Ñα╕¡α╕öα╕áα╕▒α╕ó α╣üα╕Ñα╕░α╕¬α╕░α╕öα╕ºα╕üα╕úα╕ºα╕öα╣Çα╕úα╣çα╕º</p>
                    <p>Γ£à α╣äα╕íα╣êα╕òα╣ëα╕¡α╕çα╕êα╕öα╕êα╕│α╕úα╕½α╕▒α╕¬α╕£α╣êα╕▓α╕Ö</p>
                  </div>
                </div>
              )}

              {/* Info */}
              <div className="mt-6 pt-6 border-t border-slate-800">
                <div className="text-xs text-slate-400 space-y-1">
                  <p>≡ƒÆí <strong>α╕ùα╕öα╕¬α╕¡α╕Üα╕úα╕░α╕Üα╕Ü:</strong> α╣âα╕èα╣ë World ID α╕öα╣ëα╕▓α╕Öα╕Üα╕Öα╣Çα╕₧α╕╖α╣êα╕¡α╕ùα╕öα╕¬α╕¡α╕Ü</p>
                  <p>≡ƒùä∩╕Å <strong>α╕éα╣ëα╕¡α╕íα╕╣α╕Ñα╕êα╕úα╕┤α╕ç:</strong> α╣Çα╕èα╕╖α╣êα╕¡α╕íα╕üα╕▒α╕Ü PostgreSQL Database</p>
                </div>
              </div>
            </div>

            {/* Footer */}
            <div className="text-center mt-6 text-xs text-slate-500">
              Fingrow v2.0 - Real Database Connection
            </div>
          </div>
        </div>
      );
    }

    // Insurance Selection Modal Component
    function InsuranceSelectionModal({ level, userId, onClose }) {
      const [products, setProducts] = useState([]);
      const [modalSelectedProducts, setModalSelectedProducts] = useState([]);
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);

      useEffect(() => {
        const fetchData = async () => {
          try {
            setLoading(true);
            // Fetch available products for this level
            const productsRes = await fetch(`${API_BASE}/api/insurance/products?level=${level}`);
            if (productsRes.ok) {
              const productsData = await productsRes.json();
              setProducts(productsData.products || []);
            }

            // Fetch user's current selections
            const selectionsRes = await fetch(`${API_BASE}/api/insurance/selections/${userId}`);
            if (selectionsRes.ok) {
              const selectionsData = await selectionsRes.json();
              const levelSelections = selectionsData.selections
                .filter(s => s.product.fingrowLevel === level)
                .map(s => s.insuranceProductId);
              setModalSelectedProducts(levelSelections);
            }
          } catch (error) {
            console.error('Error fetching insurance data:', error);
          } finally {
            setLoading(false);
          }
        };

        fetchData();
      }, [level, userId]);

      const toggleProduct = (productId) => {
        if (modalSelectedProducts.includes(productId)) {
          setModalSelectedProducts(modalSelectedProducts.filter(id => id !== productId));
        } else {
          setModalSelectedProducts([...modalSelectedProducts, productId]);
        }
      };

      const handleSave = async () => {
        try {
          setSaving(true);

          // Get current selections from server
          const selectionsRes = await fetch(`${API_BASE}/api/insurance/selections/${userId}`);
          const selectionsData = await selectionsRes.json();
          const currentLevelSelections = selectionsData.selections.filter(
            s => s.product.fingrowLevel === level
          );

          // Deactivate products that were unselected
          for (const selection of currentLevelSelections) {
            if (!modalSelectedProducts.includes(selection.insuranceProductId)) {
              await fetch(`${API_BASE}/api/insurance/selections/${selection.id}`, {
                method: 'DELETE'
              });
            }
          }

          // Add new products that were selected
          const currentIds = currentLevelSelections.map(s => s.insuranceProductId);
          for (const productId of modalSelectedProducts) {
            if (!currentIds.includes(productId)) {
              await fetch(`${API_BASE}/api/insurance/selections`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, insuranceProductId: productId })
              });
            }
          }

          onClose();
        } catch (error) {
          console.error('Error saving selections:', error);
          alert('α╣Çα╕üα╕┤α╕öα╕éα╣ëα╕¡α╕£α╕┤α╕öα╕₧α╕Ñα╕▓α╕öα╣âα╕Öα╕üα╕▓α╕úα╕Üα╕▒α╕Öα╕ùα╕╢α╕ü α╕üα╕úα╕╕α╕ôα╕▓α╕Ñα╕¡α╕çα╣âα╕½α╕íα╣ê');
        } finally {
          setSaving(false);
        }
      };

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
          <div className="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-lg max-h-[90vh] flex flex-col shadow-2xl">
            {/* Header */}
            <div className="flex items-center justify-between p-5 border-b border-slate-800">
              <h2 className="text-lg font-bold">α╣Çα╕Ñα╕╖α╕¡α╕üα╣üα╕£α╕Öα╕¢α╕úα╕░α╕üα╕▒α╕Ö Level {level}</h2>
              <button
                onClick={onClose}
                className="w-8 h-8 rounded-lg bg-slate-800 hover:bg-slate-700 flex items-center justify-center text-slate-400 hover:text-white transition-colors"
              >
                Γ£ò
              </button>
            </div>

            {/* Content */}
            <div className="flex-1 overflow-y-auto p-5">
              {loading ? (
                <div className="text-center py-12 text-slate-400">α╕üα╕│α╕Ñα╕▒α╕çα╣éα╕½α╕Ñα╕ö...</div>
              ) : products.length === 0 ? (
                <div className="text-center py-12 text-slate-400">α╣äα╕íα╣êα╕íα╕╡α╣üα╕£α╕Öα╕¢α╕úα╕░α╕üα╕▒α╕Öα╕¬α╕│α╕½α╕úα╕▒α╕Ü Level α╕Öα╕╡α╣ë</div>
              ) : (
                <div className="space-y-3">
                  {products.map((product) => (
                    <div
                      key={product.id}
                      onClick={() => toggleProduct(product.id)}
                      className={`p-4 rounded-xl border-2 cursor-pointer transition-all ${
                        modalSelectedProducts.includes(product.id)
                          ? 'border-emerald-500 bg-emerald-500/10'
                          : 'border-slate-700 bg-slate-800/40 hover:border-slate-600'
                      }`}
                    >
                      <div className="flex items-start gap-3">
                        <div className={`w-5 h-5 mt-0.5 rounded border-2 flex items-center justify-center flex-shrink-0 ${
                          modalSelectedProducts.includes(product.id)
                            ? 'border-emerald-500 bg-emerald-500'
                            : 'border-slate-600'
                        }`}>
                          {modalSelectedProducts.includes(product.id) && (
                            <span className="text-white text-xs">Γ£ô</span>
                          )}
                        </div>
                        <div className="flex-1 min-w-0">
                          <h3 className="font-medium text-sm mb-1">{product.shortTitle || product.title}</h3>
                          <div className="text-xs text-slate-400 mb-2">{product.insurerCompanyName}</div>
                          <div className="flex items-center gap-3 text-xs">
                            <span className="text-cyan-300 font-medium">
                              {product.finpointPrice?.toLocaleString()} FP
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Footer */}
            <div className="p-5 border-t border-slate-800 flex gap-3">
              <button
                onClick={onClose}
                className="flex-1 px-4 py-3 rounded-xl bg-slate-800 hover:bg-slate-700 font-medium transition-colors"
              >
                α╕óα╕üα╣Çα╕Ñα╕┤α╕ü
              </button>
              <button
                onClick={handleSave}
                disabled={saving}
                className="flex-1 px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {saving ? 'α╕üα╕│α╕Ñα╕▒α╕çα╕Üα╕▒α╕Öα╕ùα╕╢α╕ü...' : 'α╕Üα╕▒α╕Öα╕ùα╕╢α╕ü'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Home Page (Dashboard)
    function HomePage({ data, user, onRefresh, setDashboardData }) {
      const [showInsuranceModal, setShowInsuranceModal] = useState(false);
      const [selectedLevel, setSelectedLevel] = useState(null);
      const [insuranceSelections, setInsuranceSelections] = useState({});
      const [loadingSelections, setLoadingSelections] = useState(true);
      const [isAddingFP, setIsAddingFP] = useState(false);
      const [showDemoFinpointModal, setShowDemoFinpointModal] = useState(false);
      const [demoAmount, setDemoAmount] = useState(1000);
      const [isQuickAdd, setIsQuickAdd] = useState(false); // Track if opened from purchase modal
      const [currentFinpoint, setCurrentFinpoint] = useState(data.currentFpBalance);
      const [purchasedProductIds, setPurchasedProductIds] = useState([]);

      // Fetch purchased products
      useEffect(() => {
        const fetchPurchased = async () => {
          try {
            const response = await fetch(`${API_BASE}/api/insurance/${user.id}/purchased`);
            if (response.ok) {
              const data = await response.json();
              setPurchasedProductIds(data.purchasedProductIds || []);
            }
          } catch (error) {
            console.error('Error fetching purchased products:', error);
          }
        };
        fetchPurchased();
      }, [user.id]);

      // Fetch user's insurance selections
      useEffect(() => {
        const fetchSelections = async () => {
          try {
            setLoadingSelections(true);
            const response = await fetch(`${API_BASE}/api/insurance/selections/${user.id}`);
            if (response.ok) {
              const data = await response.json();
              // Group selections by level
              const selectionsByLevel = {};
              data.selections.forEach(selection => {
                const level = selection.product.fingrowLevel;
                if (!selectionsByLevel[level]) {
                  selectionsByLevel[level] = [];
                }
                // Merge selection data with product data so we have insuranceProductId
                selectionsByLevel[level].push({
                  ...selection.product,
                  insuranceProductId: selection.insuranceProductId
                });
              });
              setInsuranceSelections(selectionsByLevel);
            }
          } catch (error) {
            console.error('Error fetching insurance selections:', error);
          } finally {
            setLoadingSelections(false);
          }
        };

        if (user && user.id) {
          fetchSelections();
        }
      }, [user]);

      const handleSettingsClick = (exp) => {
        // Extract level number from code (e.g., "LEVEL_1" -> 1)
        const levelMatch = exp.code.match(/LEVEL_(\d+)/);
        if (levelMatch) {
          setSelectedLevel(parseInt(levelMatch[1]));
          setShowInsuranceModal(true);
        }
      };

      const handleModalClose = () => {
        setShowInsuranceModal(false);
        setSelectedLevel(null);
        // Refresh selections after modal closes
        const fetchSelections = async () => {
          try {
            const response = await fetch(`${API_BASE}/api/insurance/selections/${user.id}`);
            if (response.ok) {
              const data = await response.json();
              const selectionsByLevel = {};
              data.selections.forEach(selection => {
                const level = selection.product.fingrowLevel;
                if (!selectionsByLevel[level]) {
                  selectionsByLevel[level] = [];
                }
                selectionsByLevel[level].push(selection.product);
              });
              setInsuranceSelections(selectionsByLevel);
            }
          } catch (error) {
            console.error('Error fetching insurance selections:', error);
          }
        };
        fetchSelections();
      };

      return (
        <div className="pb-4">
          {/* Insurance Selection Modal */}
          {showInsuranceModal && (
            <InsuranceSelectionModal
              level={selectedLevel}
              userId={user.id}
              onClose={handleModalClose}
            />
          )}

          {/* Header */}
          <header className="sticky top-0 z-20 bg-slate-900/95 backdrop-blur-lg border-b border-slate-800">
            <div className="px-4 py-3 flex items-center justify-between">
              <div className="flex items-center gap-2">
                <div className="w-8 h-8 rounded-full bg-emerald-400/20 border border-emerald-400/50 flex items-center justify-center text-xs font-bold text-emerald-300">
                  FG
                </div>
                <div>
                  <h1 className="text-sm font-semibold">Fingrow</h1>
                  <p className="text-xs text-slate-400">Dashboard</p>
                </div>
              </div>
              <div className="flex items-center gap-2 text-xs">
                <span className="hidden sm:inline text-slate-400">α╕¬α╕ºα╕▒α╕¬α╕öα╕╡,</span>
                <span className="font-medium">{user.firstName}</span>
                <div className="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center overflow-hidden">
                  {user.avatarUrl ? (
                    <img src={user.avatarUrl} alt={user.username} className="w-full h-full object-cover" />
                  ) : (
                    <span>≡ƒæñ</span>
                  )}
                </div>
              </div>
            </div>
          </header>

          {/* FP Balance Card */}
          <section className="p-4">
            <div className="bg-gradient-to-br from-emerald-900/60 to-teal-900/60 border border-emerald-700/50 rounded-2xl p-5 shadow-lg">
              <div className="flex items-start justify-between mb-3">
                <div>
                  <h2 className="text-xs uppercase tracking-wide text-emerald-300/80">α╕óα╕¡α╕ö Finpoint</h2>
                  <p className="mt-1 text-3xl sm:text-4xl font-bold text-emerald-300">
                    {data.currentFpBalance.toLocaleString()} <span className="text-lg">FP</span>
                  </p>
                </div>
                <div className="flex items-start">
                  <div className="w-20 h-20 bg-emerald-400/20 rounded-full flex items-center justify-center overflow-hidden -mr-2">
                    <img src="/Finpoint_image-removebg-preview.png" alt="Finpoint" className="w-full h-full object-cover scale-125" />
                  </div>
                </div>
              </div>
              <div className="flex items-center justify-between">
                <div className="text-xs text-emerald-300/60">
                  α╕¡α╕▒α╕¢α╣Çα╕öα╕òα╕Ñα╣êα╕▓α╕¬α╕╕α╕ö: {data.lastUpdated}
                </div>
                <button
                  onClick={() => {
                    setIsQuickAdd(false);
                    setDemoAmount(1000);
                    setShowDemoFinpointModal(true);
                  }}
                  data-demo-finpoint
                  className="px-4 py-2 bg-gradient-to-r from-yellow-500 to-amber-600 hover:from-yellow-600 hover:to-amber-700 text-white text-xs font-bold rounded-lg transition-all shadow-lg shadow-yellow-500/50 flex items-center gap-2"
                >
                  <span>≡ƒÆ│</span>
                  <span>α╕úα╕▒α╕Ü Finpoint (Demo)</span>
                </button>
              </div>
            </div>
          </section>

          {/* Demo Finpoint Purchase Modal */}
          {showDemoFinpointModal && (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" onClick={() => setShowDemoFinpointModal(false)}>
              <div className="bg-slate-900 border border-slate-700 rounded-2xl p-6 max-w-md w-full shadow-2xl" onClick={(e) => e.stopPropagation()}>
                <div className="text-center mb-6">
                  <div className="text-5xl mb-3">ΓÜá∩╕Å</div>
                  <h3 className="text-xl font-bold text-amber-300 mb-2">Demo Finpoint</h3>
                  <p className="text-sm text-slate-300 leading-relaxed">
                    α╕Öα╕╡α╣êα╣Çα╕¢α╣çα╕Ö <span className="font-semibold text-amber-300">Demo Finpoint</span> α╣Çα╕₧α╕╖α╣êα╕¡α╣âα╕èα╣ëα╕ùα╕öα╕¬α╕¡α╕Üα╕úα╕░α╕Üα╕Üα╣Çα╕ùα╣êα╕▓α╕Öα╕▒α╣ëα╕Ö
                  </p>
                  <p className="text-xs text-slate-400 mt-2">
                    α╣Çα╕íα╕╖α╣êα╕¡α╕úα╕░α╕Üα╕Üα╣Çα╕¢α╕┤α╕öα╣âα╕èα╣ëα╕êα╕úα╕┤α╕ç α╕òα╣ëα╕¡α╕çα╣âα╕èα╣ëα╣Çα╕çα╕┤α╕Öα╕êα╕úα╕┤α╕çα╣âα╕Öα╕üα╕▓α╕úα╕ïα╕╖α╣ëα╕¡ Finpoint
                  </p>
                </div>

                <div className="bg-slate-800/50 rounded-xl p-4 mb-6">
                  <label className="block text-xs text-slate-400 mb-2">α╕êα╕│α╕Öα╕ºα╕Ö Finpoint α╕ùα╕╡α╣êα╕òα╣ëα╕¡α╕çα╕üα╕▓α╕ú</label>
                  <div className="flex items-center gap-2">
                    <input
                      type="number"
                      value={demoAmount}
                      onChange={(e) => setDemoAmount(Math.max(0, parseInt(e.target.value) || 0))}
                      className="flex-1 px-4 py-3 bg-slate-900 border border-slate-700 rounded-lg text-lg font-semibold text-center focus:outline-none focus:border-emerald-500"
                      min="0"
                      step="100"
                      readOnly={isQuickAdd}
                    />
                    <span className="text-slate-400 font-medium">FP</span>
                  </div>
                  {!isQuickAdd && (
                    <div className="flex gap-2 mt-3">
                      {[500, 1000, 5000, 10000].map(amount => (
                        <button
                          key={amount}
                          onClick={() => setDemoAmount(amount)}
                          className="flex-1 px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-xs rounded-lg transition-colors"
                        >
                          {amount.toLocaleString()}
                        </button>
                      ))}
                    </div>
                  )}
                  {isQuickAdd && (
                    <div className="mt-2 text-xs text-emerald-400 text-center">
                      Γ£ô α╕êα╕│α╕Öα╕ºα╕Öα╕ùα╕╡α╣êα╕óα╕▒α╕çα╕éα╕▓α╕öα╕¬α╕│α╕½α╕úα╕▒α╕Üα╕üα╕▓α╕úα╕ïα╕╖α╣ëα╕¡α╕¢α╕úα╕░α╕üα╕▒α╕Ö
                    </div>
                  )}
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={() => {
                      setShowDemoFinpointModal(false);
                      setIsQuickAdd(false);
                    }}
                    className="flex-1 px-4 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-lg font-medium transition-colors"
                  >
                    α╕óα╕üα╣Çα╕Ñα╕┤α╕ü
                  </button>
                  <button
                    onClick={async () => {
                      if (isAddingFP) return; // Prevent double submission

                      try {
                        setIsAddingFP(true);
                        const response = await fetch(`${API_BASE}/api/users/${user.id}/demo-finpoint`, {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({ amount: demoAmount })
                        });
                        if (response.ok) {
                          const result = await response.json();
                          setCurrentFinpoint(result.data.newFinpoint);
                          data.currentFpBalance = result.data.newFinpoint;

                          // Refresh insurance levels to update FP balance
                          const levelsResponse = await fetch(`${API_BASE}/api/insurance/${user.id}/levels`);
                          if (levelsResponse.ok) {
                            const levelsData = await levelsResponse.json();
                            // Update dashboard data with new levels
                            setDashboardData(prev => ({
                              ...prev,
                              currentFpBalance: result.data.newFinpoint,
                              expProgressList: levelsData.levels || []
                            }));
                          }

                          setShowDemoFinpointModal(false);
                          setIsQuickAdd(false);
                          alert(`α╣Çα╕òα╕┤α╕í ${demoAmount.toLocaleString()} FP α╕¬α╕│α╣Çα╕úα╣çα╕ê!`);
                        }
                      } catch (error) {
                        console.error('Error purchasing demo finpoint:', error);
                        alert('α╣Çα╕üα╕┤α╕öα╕éα╣ëα╕¡α╕£α╕┤α╕öα╕₧α╕Ñα╕▓α╕ö α╕üα╕úα╕╕α╕ôα╕▓α╕Ñα╕¡α╕çα╕¡α╕╡α╕üα╕äα╕úα╕▒α╣ëα╕ç');
                      } finally {
                        setIsAddingFP(false);
                      }
                    }}
                    disabled={isAddingFP}
                    className={`flex-1 px-4 py-3 ${isAddingFP ? 'bg-emerald-800 cursor-not-allowed' : 'bg-emerald-600 hover:bg-emerald-700'} text-white rounded-lg font-medium transition-colors`}
                  >
                    {isAddingFP ? 'α╕üα╕│α╕Ñα╕▒α╕çα╣Çα╕òα╕┤α╕í...' : 'α╕úα╕▒α╕Ü Finpoint'}
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Level Progress */}
          <section className="px-4 pb-4">
            <div className="flex items-center justify-between mb-3">
              <h3 className="text-sm font-semibold">α╣Çα╕¢α╣ëα╕▓α╕½α╕íα╕▓α╕ó Level</h3>
              <span className="text-xs text-slate-400">α╣âα╕èα╣ë FP α╕ïα╕╖α╣ëα╕¡α╕¢α╕úα╕░α╕üα╕▒α╕Ö</span>
            </div>
            <div className="space-y-3">
              {data.expProgressList.map((exp) => {
                const levelMatch = exp.code.match(/LEVEL_(\d+)/);
                const levelNum = levelMatch ? parseInt(levelMatch[1]) : null;
                const selectedProducts = levelNum && insuranceSelections[levelNum] ? insuranceSelections[levelNum] : [];

                return (
                  <ExpCard
                    key={exp.code}
                    exp={exp}
                    selectedProducts={selectedProducts}
                    userId={user.id}
                    currentFpBalance={data.currentFpBalance}
                    purchasedProductIds={purchasedProductIds}
                    onSettingsClick={handleSettingsClick}
                    onOpenDemoFinpoint={(amount) => {
                      setDemoAmount(amount);
                      setIsQuickAdd(true);
                      setShowDemoFinpointModal(true);
                    }}
                    onPurchaseComplete={() => {
                      // Refresh data after purchase
                      if (onRefresh) onRefresh();
                      // Refresh purchased list
                      fetch(`${API_BASE}/api/insurance/${user.id}/purchased`)
                        .then(res => res.json())
                        .then(data => setPurchasedProductIds(data.purchasedProductIds || []));
                    }}
                  />
                );
              })}
            </div>
          </section>
        </div>
      );
    }

    // Transactions Page (α╕úα╕▓α╕óα╕üα╕▓α╕ú)
    function TransactionsPage({ data, user }) {
      const [filter, setFilter] = useState('all'); // all, dr, cr
      const [uplineList, setUplineList] = useState([]);
      const [loadingUpline, setLoadingUpline] = useState(true);
      const [transactions, setTransactions] = useState([]);
      const [loadingTransactions, setLoadingTransactions] = useState(true);
      const [transactionSummary, setTransactionSummary] = useState({
        totalFinpoint: 0,
        totalReceived: 0,
        totalSpent: 0
      });

      // Fetch upline list
      useEffect(() => {
        const fetchUplineList = async () => {
          try {
            setLoadingUpline(true);
            const response = await fetch(`${API_BASE}/api/users/${user.id}/upline-list`);
            if (response.ok) {
              const data = await response.json();
              setUplineList(data.uplines || []);
            }
          } catch (error) {
            console.error('Error fetching upline list:', error);
          } finally {
            setLoadingUpline(false);
          }
        };

        if (user && user.id) {
          fetchUplineList();
        }
      }, [user]);

      // Fetch transactions from commission_pool_distribution
      useEffect(() => {
        const fetchTransactions = async () => {
          try {
            setLoadingTransactions(true);
            const response = await fetch(`${API_BASE}/api/users/${user.id}/transactions`);
            if (response.ok) {
              const result = await response.json();
              if (result.success) {
                setTransactions(result.data.transactions || []);
                setTransactionSummary(result.data.summary || {
                  totalFinpoint: 0,
                  totalReceived: 0,
                  totalSpent: 0
                });
              }
            }
          } catch (error) {
            console.error('Error fetching transactions:', error);
            // Fallback to mock data if API fails
            setTransactions(data.recentLedger || []);
          } finally {
            setLoadingTransactions(false);
          }
        };

        if (user && user.id) {
          fetchTransactions();
        }
      }, [user]);

      const filteredLedger = transactions.filter(row => {
        if (filter === 'all') return true;
        return row.drCr && row.drCr.toLowerCase() === filter;
      });

      return (
        <div className="pb-4">
          {/* Header */}
          <header className="sticky top-0 z-20 bg-slate-900/95 backdrop-blur-lg border-b border-slate-800">
            <div className="px-4 py-3">
              <h1 className="text-base font-semibold">α╕úα╕▓α╕óα╕üα╕▓α╕úα╕ÿα╕╕α╕úα╕üα╕úα╕úα╕í</h1>
              <p className="text-xs text-slate-400 mt-1">α╕¢α╕úα╕░α╕ºα╕▒α╕òα╕┤α╕üα╕▓α╕úα╣âα╕èα╣ëα╕çα╕▓α╕Ö Finpoint</p>
            </div>
          </header>

          {/* Commission Pool List */}
          <section className="p-4">
            <div className="bg-slate-900/60 border border-slate-800 rounded-2xl p-4">
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-sm font-semibold text-slate-200">Commission Pool List</h3>
                <span className="text-xs text-slate-400">{uplineList.length} α╕äα╕Ö</span>
              </div>
              {loadingUpline ? (
                <div className="text-center py-4 text-slate-400 text-sm">
                  α╕üα╕│α╕Ñα╕▒α╕çα╣éα╕½α╕Ñα╕ö...
                </div>
              ) : uplineList.length === 0 ? (
                <div className="text-center py-4 text-slate-400 text-sm">
                  α╣äα╕íα╣êα╕íα╕╡ upline
                </div>
              ) : (
                <div className="space-y-2">
                  {uplineList.map((upline, idx) => (
                    <div key={upline.id} className="flex items-center gap-3 p-3 bg-slate-800/40 rounded-lg">
                      <div className="w-8 h-8 rounded-full bg-emerald-600/20 text-emerald-300 flex items-center justify-center text-xs font-bold">
                        {idx + 1}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="text-sm font-medium text-slate-200 truncate">{upline.username}</div>
                        <div className="text-xs text-slate-400">{upline.worldId}</div>
                      </div>
                      <div className="text-xs text-slate-500">
                        Level {upline.level}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </section>

          {/* Summary Card */}
          <section className="px-4 pb-4">
            <div className="bg-gradient-to-br from-slate-900/60 to-slate-800/60 border border-slate-700/50 rounded-2xl p-4">
              {loadingTransactions ? (
                <div className="text-center py-4 text-slate-400 text-sm">
                  α╕üα╕│α╕Ñα╕▒α╕çα╣éα╕½α╕Ñα╕öα╕¬α╕úα╕╕α╕¢...
                </div>
              ) : (
                <div className="grid grid-cols-3 gap-3 text-center">
                  <div>
                    <div className="text-xs text-slate-400 mb-1">α╕óα╕¡α╕öα╕äα╕çα╣Çα╕½α╕Ñα╕╖α╕¡</div>
                    <div className="text-lg font-bold text-emerald-300">{transactionSummary.totalFinpoint.toLocaleString()}</div>
                    <div className="text-xs text-slate-500">FP</div>
                  </div>
                  <div>
                    <div className="text-xs text-slate-400 mb-1">α╕úα╕▒α╕Üα╣Çα╕éα╣ëα╕▓</div>
                    <div className="text-lg font-bold text-emerald-300">
                      {transactionSummary.totalReceived.toLocaleString()}
                    </div>
                    <div className="text-xs text-slate-500">FP</div>
                  </div>
                  <div>
                    <div className="text-xs text-slate-400 mb-1">α╕êα╣êα╕▓α╕óα╕¡α╕¡α╕ü</div>
                    <div className="text-lg font-bold text-rose-300">
                      {transactionSummary.totalSpent.toLocaleString()}
                    </div>
                    <div className="text-xs text-slate-500">FP</div>
                  </div>
                </div>
              )}
            </div>
          </section>

          {/* Filter Tabs */}
          <section className="px-4 pb-3">
            <div className="flex gap-2">
              <button onClick={() => setFilter('all')}
                className={`flex-1 py-2 rounded-lg text-sm font-medium transition ${
                  filter === 'all' ? 'bg-emerald-600 text-white' : 'bg-slate-800 text-slate-300'
                }`}>
                α╕ùα╕▒α╣ëα╕çα╕½α╕íα╕ö ({transactions.length})
              </button>
              <button onClick={() => setFilter('dr')}
                className={`flex-1 py-2 rounded-lg text-sm font-medium transition ${
                  filter === 'dr' ? 'bg-emerald-600 text-white' : 'bg-slate-800 text-slate-300'
                }`}>
                α╕úα╕▒α╕Üα╣Çα╕éα╣ëα╕▓ ({transactions.filter(r => r.drCr === 'DR').length})
              </button>
              <button onClick={() => setFilter('cr')}
                className={`flex-1 py-2 rounded-lg text-sm font-medium transition ${
                  filter === 'cr' ? 'bg-rose-600 text-white' : 'bg-slate-800 text-slate-300'
                }`}>
                α╕êα╣êα╕▓α╕óα╕¡α╕¡α╕ü ({transactions.filter(r => r.drCr === 'CR').length})
              </button>
            </div>
          </section>

          {/* Transaction List */}
          <section className="px-4 pb-4">
            <div className="bg-slate-900/60 border border-slate-800 rounded-2xl overflow-hidden">
              {loadingTransactions ? (
                <div className="px-4 py-8 text-center text-slate-400">
                  <div className="text-3xl mb-2">ΓÅ│</div>
                  <div className="text-sm">α╕üα╕│α╕Ñα╕▒α╕çα╣éα╕½α╕Ñα╕öα╕úα╕▓α╕óα╕üα╕▓α╕ú...</div>
                </div>
              ) : filteredLedger.length === 0 ? (
                <div className="px-4 py-8 text-center text-slate-400">
                  <div className="text-3xl mb-2">≡ƒôï</div>
                  <div className="text-sm">α╣äα╕íα╣êα╕íα╕╡α╕úα╕▓α╕óα╕üα╕▓α╕ú</div>
                </div>
              ) : (
                filteredLedger.map((row, idx) => (
                  <div key={row.id} className={`px-4 py-3 ${idx > 0 ? 'border-t border-slate-800' : ''}`}>
                    <div className="flex items-start justify-between gap-3">
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-1">
                          <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm ${
                            row.drCr === 'DR' ? 'bg-emerald-500/20 text-emerald-300' : 'bg-rose-500/20 text-rose-300'
                          }`}>
                            {row.drCr === 'DR' ? 'Γåô' : 'Γåæ'}
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className="text-sm font-medium text-slate-200 truncate">{row.category}</div>
                            <div className="text-xs text-slate-400">{row.detail}</div>
                          </div>
                        </div>
                        <div className="text-xs text-slate-500 ml-10">
                          {row.datetime ? new Date(row.datetime).toLocaleString('th-TH', {
                            day: '2-digit',
                            month: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                          }) : ''}
                        </div>
                      </div>
                      <div className="text-right">
                        <div className={`text-base font-semibold ${row.drCr === 'DR' ? 'text-emerald-300' : 'text-rose-300'}`}>
                          {row.displayAmount || (row.drCr === 'DR' ? '+' : '-') + Math.abs(row.amount).toLocaleString()}
                        </div>
                        <div className="text-xs text-slate-500">
                          FP
                        </div>
                      </div>
                    </div>
                  </div>
                ))
              )}
            </div>
          </section>

          {/* Info Footer */}
          <section className="px-4 pb-4">
            <div className="bg-slate-900/40 border border-slate-800 rounded-xl p-3">
              <div className="flex items-start gap-2">
                <div className="text-slate-400 mt-0.5">Γä╣∩╕Å</div>
                <div className="flex-1">
                  <div className="text-xs text-slate-400 leading-relaxed">
                    <div className="mb-1"><span className="text-emerald-300">ΓÇó α╕úα╕▒α╕Üα╣Çα╕éα╣ëα╕▓ (DR)</span> = α╣äα╕öα╣ëα╕úα╕▒α╕Ü Finpoint α╕êα╕▓α╕üα╕üα╕▓α╕úα╕éα╕▓α╕ó, α╣éα╕Üα╕Öα╕▒α╕¬, α╕äα╕╖α╕Öα╣Çα╕çα╕┤α╕Ö</div>
                    <div><span className="text-rose-300">ΓÇó α╕êα╣êα╕▓α╕óα╕¡α╕¡α╕ü (CR)</span> = α╣âα╕èα╣ë Finpoint α╕ïα╕╖α╣ëα╕¡α╕¬α╕┤α╕Öα╕äα╣ëα╕▓, α╕Üα╕úα╕┤α╕üα╕▓α╕ú</div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>
      );
    }

    // Notifications Page
    function NotificationsPage({ user, readIds, setReadIds, setUnreadNotificationCount, isActive }) {
      const [notifications, setNotifications] = useState([]);
      const [isLoading, setIsLoading] = useState(true);
      const [error, setError] = useState('');

      useEffect(() => {
        const fetchNotifications = async () => {
          try {
            setIsLoading(true);
            setError('');
            const response = await fetch(`${API_BASE}/api/users/${user.id}/notifications`);
            if (response.ok) {
              const data = await response.json();
              const list = data.notifications || [];
              setNotifications(list);
              // Keep existing readIds; new items default unread
              const unreadCount = list.filter(n => !readIds.includes(n.id)).length;
              setUnreadNotificationCount(unreadCount);
            } else {
              setError('α╣éα╕½α╕Ñα╕öα╕üα╕▓α╕úα╣üα╕êα╣ëα╕çα╣Çα╕òα╕╖α╕¡α╕Öα╣äα╕íα╣êα╕¬α╕│α╣Çα╕úα╣çα╕ê');
            }
          } catch (err) {
            setError('α╣éα╕½α╕Ñα╕öα╕üα╕▓α╕úα╣üα╕êα╣ëα╕çα╣Çα╕òα╕╖α╕¡α╕Öα╣äα╕íα╣êα╕¬α╕│α╣Çα╕úα╣çα╕ê');
          } finally {
            setIsLoading(false);
          }
        };

        if (user?.id) {
          fetchNotifications();
        }
      }, [user?.id, isActive, readIds, setUnreadNotificationCount]);

      // When opening notifications, clear unread badge
      useEffect(() => {
        if (isActive) {
          setUnreadNotificationCount(0);
        }
      }, [isActive, setUnreadNotificationCount]);

      const unreadCount = notifications.filter(n => !readIds.includes(n.id)).length;

      const persistReadIds = (next) => {
        setReadIds(next);
        if (user?.id) {
          localStorage.setItem(`notifReadIds_${user.id}`, JSON.stringify(next));
        }
      };

      const markAsRead = (id) => {
        setReadIds((prev) => {
          if (prev.includes(id)) return prev;
          const next = [...prev, id];
          persistReadIds(next);
          return next;
        });
      };

      const markAllAsRead = () => {
        const next = notifications.map(n => n.id);
        persistReadIds(next);
      };

      return (
        <div className="min-h-screen bg-slate-950 text-slate-100 p-4">
          <div className="max-w-4xl mx-auto">
            <div className="bg-slate-900/60 border border-slate-800 rounded-2xl p-6">
              <div className="flex items-center gap-3 mb-4">
                <div className="text-2xl">≡ƒöö</div>
                <div>
                  <h2 className="text-lg font-semibold">α╕üα╕▓α╕úα╣üα╕êα╣ëα╕çα╣Çα╕òα╕╖α╕¡α╕Ö</h2>
                  <p className="text-slate-400 text-sm">α╕¡α╕▒α╕¢α╣Çα╕öα╕òα╣Çα╕üα╕╡α╣êα╕óα╕ºα╕üα╕▒α╕Üα╣Çα╕äα╕úα╕╖α╕¡α╕éα╣êα╕▓α╕óα╕éα╕¡α╕çα╕äα╕╕α╕ô</p>
                </div>
              </div>

              <div className="flex items-center justify-between mb-3">
                <div className="text-xs text-slate-400">α╣äα╕íα╣êα╣äα╕öα╣ëα╕¡α╣êα╕▓α╕Ö: {unreadCount}</div>
                {unreadCount > 0 && (
                  <button
                    onClick={markAllAsRead}
                    className="text-xs px-2 py-1 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 transition-colors"
                  >
                    α╕ùα╕│α╣Çα╕äα╕úα╕╖α╣êα╕¡α╕çα╕½α╕íα╕▓α╕óα╕ºα╣êα╕▓α╕¡α╣êα╕▓α╕Öα╣üα╕Ñα╣ëα╕ºα╕ùα╕▒α╣ëα╕çα╕½α╕íα╕ö
                  </button>
                )}
              </div>

              {isLoading ? (
                <div className="bg-slate-800/40 border border-slate-700 rounded-xl p-4 text-center text-slate-400 text-sm">
                  α╕üα╕│α╕Ñα╕▒α╕çα╣éα╕½α╕Ñα╕öα╕üα╕▓α╕úα╣üα╕êα╣ëα╕çα╣Çα╕òα╕╖α╕¡α╕Ö...
                </div>
              ) : error ? (
                <div className="bg-rose-900/20 border border-rose-500/50 rounded-xl p-4 text-center text-rose-300 text-sm">
                  {error}
                </div>
              ) : notifications.length === 0 ? (
                <div className="bg-slate-800/40 border border-slate-700 rounded-xl p-4 text-center text-slate-400 text-sm">
                  α╕óα╕▒α╕çα╣äα╕íα╣êα╕íα╕╡α╕üα╕▓α╕úα╣üα╕êα╣ëα╕çα╣Çα╕òα╕╖α╕¡α╕Öα╣âα╕½α╕íα╣ê
                </div>
              ) : (
                <div className="space-y-3">
                  {notifications.map((item, idx) => {
                    const isRead = readIds.includes(item.id);
                    return (
                      <div
                        key={idx}
                        className={`bg-slate-800/40 border rounded-xl p-4 cursor-pointer transition-colors ${
                          isRead ? 'border-slate-700 opacity-80' : 'border-emerald-700'
                        }`}
                        onClick={() => markAsRead(item.id)}
                      >
                        <div className="flex items-start justify-between gap-3">
                          <div className="flex-1">
                            <div className="flex items-center gap-2">
                              {!isRead && <span className="w-2 h-2 rounded-full bg-emerald-400 inline-block"></span>}
                              <div className="text-sm text-slate-200">{item.message}</div>
                            </div>
                            <div className="text-xs text-slate-500 mt-1">
                              {item.createdAt ? new Date(item.createdAt).toLocaleString('th-TH') : ''}
                            </div>
                          </div>
                          <div className="text-xs px-2 py-1 rounded-full bg-slate-800 text-slate-400 capitalize">
                            {item.type || 'info'}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // Tree Page
    function TreePage({ user }) {
      const [viewingUser, setViewingUser] = useState({ id: user.id, worldId: user.worldId, username: user.username, avatarUrl: user.avatarUrl, parentId: null });
      const [networkData, setNetworkData] = useState([]);
      const [isLoading, setIsLoading] = useState(true);
      const [parentInfo, setParentInfo] = useState(null);

      // Fetch network tree from API
      useEffect(() => {
        const fetchNetworkTree = async () => {
          try {
            setIsLoading(true);
            const response = await fetch(`${API_BASE}/api/network/${viewingUser.id}/tree`);
            if (response.ok) {
              const data = await response.json();

              // Store parent info if exists
              if (data.root && data.root.parentId) {
                setParentInfo({
                  id: data.root.parentId,
                  worldId: null, // Will fetch from user API
                  username: null
                });

                // Fetch parent user info
                fetch(`${API_BASE}/api/users/${data.root.parentId}`)
                  .then(res => res.json())
                  .then(parentData => {
                    setParentInfo({
                      id: parentData.id,
                      worldId: parentData.worldId,
                      username: parentData.username,
                      avatarUrl: parentData.avatarUrl
                    });
                  })
                  .catch(err => console.error('Failed to fetch parent info:', err));
              } else {
                setParentInfo(null);
              }

              // Transform API data to match component format
              if (data.children && data.children.length > 0) {
                setNetworkData([{
                  userId: viewingUser.worldId,
                  username: viewingUser.username,
                  parentId: data.root?.parentId || null,
                  childCount: data.childCount || 0,
                  avatarUrl: data.root?.avatarUrl || null,
                  children: data.children.map(child => ({
                    userId: child.userId,
                    username: child.username,
                    childCount: child.childCount || 0,
                    avatarUrl: child.avatarUrl || null,
                    children: (child.children || []).map(grandchild => ({
                      userId: grandchild.userId,
                      username: grandchild.username,
                      childCount: grandchild.childCount || 0,
                      avatarUrl: grandchild.avatarUrl || null,
                      userDbId: grandchild.userDbId
                    })),
                    userDbId: child.userDbId // Keep DB ID for navigation
                  }))
                }]);
              } else {
                // No children, show empty
                setNetworkData([{
                  userId: viewingUser.worldId,
                  username: viewingUser.username,
                  parentId: data.root?.parentId || null,
                  childCount: 0,
                  avatarUrl: data.root?.avatarUrl || null,
                  children: []
                }]);
              }
            } else {
              console.error('Failed to fetch network tree');
              setNetworkData([]);
            }
          } catch (error) {
            console.error('Error fetching network tree:', error);
            setNetworkData([]);
          } finally {
            setIsLoading(false);
          }
        };

        if (viewingUser && viewingUser.id) {
          fetchNetworkTree();
        }
      }, [viewingUser]);

      return (
        <div className="pb-4">
          {/* Header */}
          <header className="sticky top-0 z-20 bg-slate-900/95 backdrop-blur-lg border-b border-slate-800">
            <div className="px-4 py-3">
              <h1 className="text-base font-semibold">Network Tree</h1>
              <p className="text-xs text-slate-400 mt-1">α╣éα╕äα╕úα╕çα╕¬α╕úα╣ëα╕▓α╕çα╣Çα╕äα╕úα╕╖α╕¡α╕éα╣êα╕▓α╕ó (α╕éα╣ëα╕¡α╕íα╕╣α╕Ñα╕êα╕úα╕┤α╕çα╕êα╕▓α╕ü DB)</p>
            </div>
          </header>

          {/* Tree Header */}
          <section className="p-4 border-b border-slate-800 bg-slate-900/40">
            <div className="flex items-center justify-between mb-3">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center ring-2 ring-emerald-500 overflow-hidden">
                  {viewingUser.avatarUrl ? (
                    <img src={viewingUser.avatarUrl} alt={viewingUser.username} className="w-full h-full object-cover" />
                  ) : (
                    <span>≡ƒæñ</span>
                  )}
                </div>
                <div>
                  <div className="text-xs text-slate-400">View from:</div>
                  <div className="text-sm font-semibold">{viewingUser.worldId} ┬╖ {viewingUser.username}</div>
                </div>
              </div>
              <div className="flex gap-2">
                {parentInfo && (
                  <button
                    onClick={() => setViewingUser({ id: parentInfo.id, worldId: parentInfo.worldId, username: parentInfo.username, avatarUrl: parentInfo.avatarUrl })}
                    className="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 rounded-lg text-xs flex items-center gap-1"
                    title={`α╕óα╣ëα╕¡α╕Öα╕üα╕Ñα╕▒α╕Üα╣äα╕¢α╕öα╕╣ ${parentInfo.username}`}
                  >
                    <span>ΓåÉ</span>
                    <span>Back</span>
                  </button>
                )}
                {viewingUser.worldId !== user.worldId && (
                  <button
                    onClick={() => setViewingUser({ id: user.id, worldId: user.worldId, username: user.username, avatarUrl: user.avatarUrl })}
                    className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs"
                  >
                    Reset
                  </button>
                )}
              </div>
            </div>
            <p className="text-xs text-slate-400">
              α╕äα╕Ñα╕┤α╕üα╕ùα╕╡α╣êα╕üα╕▓α╕úα╣îα╕öα╕éα╕¡α╕ç user α╣Çα╕₧α╕╖α╣êα╕¡α╕öα╕╣α╣Çα╕äα╕úα╕╖α╕¡α╕éα╣êα╕▓α╕óα╕éα╕¡α╕çα╣Çα╕éα╕▓
            </p>
          </section>

          {/* Tree Content */}
          <section className="p-4">
            {isLoading ? (
              <div className="text-center py-8">
                <div className="text-2xl mb-2">ΓÅ│</div>
                <div className="text-sm text-slate-400">α╕üα╕│α╕Ñα╕▒α╕çα╣éα╕½α╕Ñα╕öα╕éα╣ëα╕¡α╕íα╕╣α╕Ñα╣Çα╕äα╕úα╕╖α╕¡α╕éα╣êα╕▓α╕ó...</div>
              </div>
            ) : networkData.length === 0 || !networkData[0].children || networkData[0].children.length === 0 ? (
              <div className="text-center py-8">
                <div className="text-2xl mb-2">≡ƒô¡</div>
                <div className="text-sm text-slate-400">α╕óα╕▒α╕çα╣äα╕íα╣êα╕íα╕╡α╣Çα╕äα╕úα╕╖α╕¡α╕éα╣êα╕▓α╕óα╣âα╕Öα╕¬α╕▓α╕óα╕çα╕▓α╕Ö</div>
              </div>
            ) : (
              <div className="space-y-6">
                {/* Loop through root's children (Level 1) */}
                {networkData[0].children.map((child, childIndex) => (
                  <div key={child.userId} className="network-row border-b border-slate-800 pb-3 last:border-0">
                    {/* Parent + Children in same row */}
                    <div className="grid grid-cols-6 gap-1">
                      {/* Parent Card - 1 column */}
                      <article
                        className="parent-card bg-gradient-to-br from-emerald-600 to-emerald-700 border-2 border-emerald-400 rounded-lg p-1.5 hover:from-emerald-500 hover:to-emerald-600 transition-all cursor-pointer min-h-[60px] flex flex-col items-center justify-center shadow-lg shadow-emerald-900/50"
                        onClick={() => {
                          if (child.userDbId) {
                            setViewingUser({ id: child.userDbId, worldId: child.userId, username: child.username, avatarUrl: child.avatarUrl });
                          }
                        }}
                      >
                        <div className="relative mb-0.5">
                          <div className="w-7 h-7 rounded-full bg-white/20 flex items-center justify-center text-[11px] ring-2 ring-white/40 overflow-hidden">
                            {child.avatarUrl ? (
                              <img src={child.avatarUrl} alt={child.username} className="w-full h-full object-cover" />
                            ) : (
                              <span>≡ƒæñ</span>
                            )}
                          </div>
                          {child.childCount > 0 && (
                            <div className="absolute -bottom-0.5 -right-0.5 bg-yellow-400 text-slate-900 text-[7px] font-bold rounded-full w-3.5 h-3.5 flex items-center justify-center ring-1 ring-emerald-700">
                              {child.childCount}
                            </div>
                          )}
                        </div>
                        <div className="text-[8.5px] text-center truncate w-full text-white leading-tight font-bold">
                          {child.username}
                        </div>
                        <div className="text-[7px] text-emerald-200 font-semibold">
                          Γùê{child.childCount || 0}
                        </div>
                      </article>

                      {/* Children Grid - 5 columns */}
                          {(child.children || []).map((grandchild) => (
                            <div
                              key={grandchild.userId}
                              className="grandchild-card bg-slate-800/20 rounded p-1 hover:bg-slate-700/40 transition-all cursor-pointer min-h-[60px] flex flex-col items-center justify-center"
                              onClick={() => {
                                if (grandchild.userDbId) {
                                  setViewingUser({ id: grandchild.userDbId, worldId: grandchild.userId, username: grandchild.username, avatarUrl: grandchild.avatarUrl });
                                }
                              }}
                            >
                              <div className="relative mb-0.5">
                                <div className="w-6 h-6 rounded-full bg-slate-700 flex items-center justify-center text-[10px] overflow-hidden">
                                  {grandchild.avatarUrl ? (
                                    <img src={grandchild.avatarUrl} alt={grandchild.username} className="w-full h-full object-cover" />
                                  ) : (
                                    <span>≡ƒæñ</span>
                                  )}
                                </div>
                                {grandchild.childCount > 0 && (
                                  <div className="absolute -bottom-0.5 -right-0.5 bg-emerald-500 text-white text-[6px] font-bold rounded-full w-3 h-3 flex items-center justify-center">
                                    {grandchild.childCount}
                                  </div>
                                )}
                              </div>
                              <div className="text-[8px] text-center truncate w-full text-slate-300 leading-tight">
                                {grandchild.username}
                              </div>
                              <div className="text-[7px] text-cyan-400">
                                Γùê{grandchild.childCount || 0}
                              </div>
                            </div>
                          ))}

                      {/* Empty Slots */}
                      {Array.from({ length: Math.max(0, 5 - (child.children || []).length) }).map((_, i) => (
                        <div
                          key={`empty-${childIndex}-${i}`}
                          className="grandchild-card empty border border-dashed border-slate-700/30 rounded p-1 bg-transparent min-h-[60px] flex flex-col items-center justify-center cursor-default"
                        >
                          <div className="w-6 h-6 rounded-full border border-dashed border-slate-600/30"></div>
                          <div className="text-[7px] text-slate-600 mt-0.5">{(child.children || []).length + i + 1}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </section>

          {/* Info Footer */}
          <section className="px-4 pb-4">
            <div className="bg-slate-900/40 border border-slate-800 rounded-xl p-3">
              <div className="flex items-start gap-2">
                <div className="text-slate-400 mt-0.5">Γä╣∩╕Å</div>
                <div className="flex-1">
                  <div className="text-xs text-slate-400 leading-relaxed">
                    <div className="mb-1">ΓÇó α╣üα╕¬α╕öα╕çα╣éα╕äα╕úα╕çα╕¬α╕úα╣ëα╕▓α╕çα╣Çα╕äα╕úα╕╖α╕¡α╕éα╣êα╕▓α╕óα╣üα╕Üα╕Ü hierarchical (parent ΓåÆ children)</div>
                    <div>ΓÇó α╕¬α╕╣α╕çα╕¬α╕╕α╕ö 5 α╕Ñα╕╣α╕üα╕òα╣êα╕¡ 1 parent ΓÇó α╕äα╕Ñα╕┤α╕üα╕ùα╕╡α╣êα╣éα╕¢α╕úα╣äα╕ƒα╕Ñα╣îα╣Çα╕₧α╕╖α╣êα╕¡α╕öα╕╣α╣Çα╕äα╕úα╕╖α╕¡α╕éα╣êα╕▓α╕óα╕óα╣êα╕¡α╕ó</div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>
      );
    }

    // Shop Page
    function ShopPage() {
      return (
        <div className="min-h-screen flex items-center justify-center px-4">
          <div className="text-center">
            <div className="text-5xl mb-4">≡ƒ¢Æ</div>
            <h2 className="text-xl font-bold mb-2">α╕ïα╕╖α╣ëα╕¡α╕éα╕▓α╕óα╕éα╕¡α╕çα╕íα╕╖α╕¡α╕¬α╕¡α╕ç</h2>
            <p className="text-slate-400 text-sm">α╕üα╕│α╕Ñα╕▒α╕çα╕₧α╕▒α╕Æα╕Öα╕▓...</p>
          </div>
        </div>
      );
    }

    // ACF Page
    function ACFPage({ user }) {
      const [userNetwork, setUserNetwork] = useState([]);
      const [isLoading, setIsLoading] = useState(true);

      // Fetch ACF network from API
      useEffect(() => {
        const fetchACFNetwork = async () => {
          try {
            setIsLoading(true);
            const response = await fetch(`${API_BASE}/api/network/${user.id}/acf`);
            if (response.ok) {
              const data = await response.json();
              // Transform API data to match component format
              if (data.nodes && data.nodes.length > 0) {
                // Sort by level (ascending), then by createdAt (ascending)
                const sortedNodes = data.nodes.sort((a, b) => {
                  if (a.level !== b.level) {
                    return a.level - b.level; // Level α╕Öα╣ëα╕¡α╕óα╕¡α╕óα╕╣α╣êα╕Üα╕Ö
                  }
                  return new Date(a.createdAt) - new Date(b.createdAt); // α╕¬α╕íα╕▒α╕äα╕úα╕üα╣êα╕¡α╕Öα╕¡α╕óα╕╣α╣êα╕Üα╕Ö
                });

                setUserNetwork(sortedNodes.map(node => ({
                  id: node.id,
                  userId: node.userId,
                  username: node.username,
                  inviterUsername: node.inviterUsername,
                  parentId: node.parentId,
                  parentUsername: node.parentUsername,
                  level: node.level,
                  networkSize: node.networkSize || 0,
                  maxChildren: node.maxChildren || 5,
                  childCount: node.childCount || 0,
                  acfAccepting: node.acfAccepting || false,
                  childrenLevel1: node.childrenLevel1 || [],
                  children: node.children || [],
                  createdAt: node.createdAt
                })));
              } else {
                // Set current user as root if no network data
                setUserNetwork([{
                  id: user.id,
                  userId: user.worldId,
                  username: user.username,
                  parentId: null,
                  level: user.level || 0,
                  networkSize: 1,
                  maxChildren: user.maxChildren || 5,
                  childCount: user.childCount || 0,
                  acfAccepting: user.acfAccepting || false,
                  children: []
                }]);
              }
            } else {
              console.error('Failed to fetch ACF network');
              setUserNetwork([]);
            }
          } catch (error) {
            console.error('Error fetching ACF network:', error);
            setUserNetwork([]);
          } finally {
            setIsLoading(false);
          }
        };

        if (user && user.id) {
          fetchACFNetwork();
        }
      }, [user]);

      return (
        <div className="pb-4">
          {/* Header */}
          <header className="sticky top-0 z-20 bg-slate-900/95 backdrop-blur-lg border-b border-slate-800">
            <div className="px-4 py-3">
              <h1 className="text-base font-semibold">ACF Network</h1>
              <p className="text-xs text-slate-400 mt-1">α╕úα╕░α╕Üα╕Üα╣Çα╕äα╕úα╕╖α╕¡α╕éα╣êα╕▓α╕ó Auto Connection Fill (α╕éα╣ëα╕¡α╕íα╕╣α╕Ñα╕êα╕úα╕┤α╕ç)</p>
            </div>
          </header>

          {/* Root Info */}
          <section className="p-4 border-b border-slate-800 bg-slate-900/40">
            <div className="flex items-center justify-between">
              <div>
                <label className="block text-sm font-medium mb-1">Root α╕ùα╕╡α╣êα╕òα╣ëα╕¡α╕çα╕üα╕▓α╕úα╕öα╕╣</label>
                <div className="text-base font-semibold text-emerald-400">
                  {user.worldId} - {user.username}
                </div>
              </div>
              <div className="text-right">
                <div className="text-xs text-slate-400">Level</div>
                <div className="text-lg font-bold">{user.level || 0}</div>
              </div>
            </div>
            <p className="text-xs text-slate-400 mt-2">
              * α╕éα╣ëα╕¡α╕íα╕╣α╕Ñα╕êα╕▓α╕üα╕Éα╕▓α╕Öα╕éα╣ëα╕¡α╕íα╕╣α╕Ñα╕êα╕úα╕┤α╕ç - α╣üα╕¬α╕öα╕çα╣Çα╕äα╕úα╕╖α╕¡α╕éα╣êα╕▓α╕óα╕áα╕▓α╕óα╣âα╕òα╣ëα╕¬α╕▓α╕óα╕çα╕▓α╕Öα╕éα╕¡α╕çα╕äα╕╕α╕ô
            </p>
          </section>

          {/* Network Table */}
          <section className="p-4">
            {isLoading ? (
              <div className="text-center py-8">
                <div className="text-2xl mb-2">ΓÅ│</div>
                <div className="text-sm text-slate-400">α╕üα╕│α╕Ñα╕▒α╕çα╣éα╕½α╕Ñα╕öα╕éα╣ëα╕¡α╕íα╕╣α╕Ñ ACF...</div>
              </div>
            ) : userNetwork.length === 0 ? (
              <div className="text-center py-8">
                <div className="text-2xl mb-2">≡ƒô¡</div>
                <div className="text-sm text-slate-400">α╣äα╕íα╣êα╕₧α╕Üα╕éα╣ëα╕¡α╕íα╕╣α╕Ñα╣Çα╕äα╕úα╕╖α╕¡α╕éα╣êα╕▓α╕ó</div>
              </div>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full text-sm border-collapse">
                <thead className="sticky top-0 bg-slate-800">
                  <tr className="border-b border-slate-700">
                    <th className="px-3 py-3 text-left font-medium text-slate-300">#</th>
                    <th className="px-3 py-3 text-left font-medium text-slate-300">User</th>
                    <th className="px-3 py-3 text-left font-medium text-slate-300">Invitor</th>
                    <th className="px-3 py-3 text-left font-medium text-slate-300">Parent</th>
                    <th className="px-3 py-3 text-left font-medium text-slate-300">Level</th>
                    <th className="px-3 py-3 text-left font-medium text-slate-300">Network</th>
                    <th className="px-3 py-3 text-left font-medium text-slate-300">Max</th>
                    <th className="px-3 py-3 text-left font-medium text-slate-300">Count</th>
                    <th className="px-3 py-3 text-left font-medium text-slate-300">ACF</th>
                    <th className="px-3 py-3 text-left font-medium text-slate-300" colSpan="5">Childs Level 1</th>
                  </tr>
                </thead>
                <tbody>
                  {userNetwork.map((node, index) => (
                    <tr key={node.id} className="border-b border-slate-800 hover:bg-slate-800/40">
                      <td className="px-3 py-3 font-mono text-slate-400">{index + 1}</td>
                      <td className="px-3 py-3">
                        <button className="underline underline-offset-2 hover:text-emerald-400">
                          {node.username}
                        </button>
                      </td>
                      <td className="px-3 py-3 text-slate-400">{node.inviterUsername || 'ΓÇö'}</td>
                      <td className="px-3 py-3 text-slate-400">{node.parentUsername || 'ΓÇö'}</td>
                      <td className="px-3 py-3">{node.level}</td>
                      <td className="px-3 py-3 font-mono">{node.networkSize}/19531</td>
                      <td className="px-3 py-3 text-slate-400">5</td>
                      <td className="px-3 py-3">
                        <span className="px-2 py-1 bg-slate-700 text-slate-300 rounded-full text-xs">
                          {node.childCount}/5
                        </span>
                      </td>
                      <td className="px-3 py-3">
                        <button className={`px-3 py-1 rounded-lg border text-xs font-medium ${
                          node.acfAccepting
                            ? 'border-emerald-500 text-emerald-400'
                            : 'border-rose-500 text-rose-400'
                        }`}>
                          {node.acfAccepting ? 'ON' : 'OFF'}
                        </button>
                      </td>
                      {node.childrenLevel1 && node.childrenLevel1.length > 0 ? (
                        node.childrenLevel1.map((child, i) => (
                          <td key={i} className="px-3 py-3 text-sm">
                            <button className="text-teal-400 hover:text-teal-300 underline underline-offset-2">
                              {child.username}
                            </button>
                          </td>
                        ))
                      ) : null}
                      {Array(5 - (node.childrenLevel1?.length || 0)).fill(null).map((_, i) => (
                        <td key={`empty-${i}`} className="px-3 py-3 text-slate-500">ΓÇö</td>
                      ))}
                    </tr>
                  ))}
                </tbody>
              </table>
              </div>
            )}
          </section>

          {/* Info Footer */}
          <section className="px-4 pb-4">
            <div className="bg-slate-900/40 border border-slate-800 rounded-xl p-3">
              <div className="flex items-start gap-2">
                <div className="text-slate-400 mt-0.5">Γä╣∩╕Å</div>
                <div className="flex-1">
                  <div className="text-xs text-slate-400 leading-relaxed">
                    <div className="mb-1">ΓÇó α╕äα╕╕α╕ôα╕¬α╕▓α╕íα╕▓α╕úα╕ûα╕öα╕╣α╣Çα╕äα╕úα╕╖α╕¡α╕éα╣êα╕▓α╕óα╕áα╕▓α╕óα╣âα╕òα╣ëα╕¬α╕▓α╕óα╕çα╕▓α╕Öα╕éα╕¡α╕çα╕äα╕╕α╕ôα╣Çα╕ùα╣êα╕▓α╕Öα╕▒α╣ëα╕Ö</div>
                    <div>ΓÇó α╕òα╕▓α╕úα╕▓α╕çα╣üα╕¬α╕öα╕çα╣éα╕äα╕úα╕çα╕¬α╕úα╣ëα╕▓α╕çα╣Çα╕äα╕úα╕╖α╕¡α╕éα╣êα╕▓α╕ó ACF α╣üα╕Ñα╕░α╕¬α╕ûα╕▓α╕Öα╕░α╕üα╕▓α╕úα╣Çα╕¢α╕┤α╕öα╕úα╕▒α╕Üα╕¬α╕íα╕▓α╕èα╕┤α╕üα╣âα╕½α╕íα╣ê</div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>
      );
    }

    // Profile Page (Simplified)
    function ProfilePage({ user, setUser, onLogout }) {
      const [editing, setEditing] = useState(false);
      const [form, setForm] = useState(user);
      const [uploadingAvatar, setUploadingAvatar] = useState(false);

      const handleSave = () => {
        setUser(form);
        setEditing(false);
        alert('Γ£à α╕Üα╕▒α╕Öα╕ùα╕╢α╕üα╕éα╣ëα╕¡α╕íα╕╣α╕Ñα╕¬α╕│α╣Çα╕úα╣çα╕ê!');
      };

      const handleLogout = () => {
        if (confirm('α╕òα╣ëα╕¡α╕çα╕üα╕▓α╕úα╕¡α╕¡α╕üα╕êα╕▓α╕üα╕úα╕░α╕Üα╕Üα╕½α╕úα╕╖α╕¡α╣äα╕íα╣ê?')) {
          onLogout();
        }
      };

      const handleAvatarUpload = async (event) => {
        const file = event.target.files?.[0];
        if (!file) return;

        try {
          setUploadingAvatar(true);

          const formData = new FormData();
          formData.append('avatar', file);

          const response = await fetch(`${API_BASE}/api/users/${user.id}/upload-avatar`, {
            method: 'POST',
            body: formData,
          });

          if (!response.ok) {
            throw new Error('Failed to upload avatar');
          }

          const data = await response.json();
          setUser(data.profile);
          setForm(data.profile);
          alert('Γ£à α╕¡α╕▒α╕¢α╣éα╕½α╕Ñα╕öα╕úα╕╣α╕¢α╣éα╕¢α╕úα╣äα╕ƒα╕Ñα╣îα╕¬α╕│α╣Çα╕úα╣çα╕ê!');
        } catch (error) {
          console.error('Failed to upload avatar:', error);
          alert('Γ¥î α╣äα╕íα╣êα╕¬α╕▓α╕íα╕▓α╕úα╕ûα╕¡α╕▒α╕¢α╣éα╕½α╕Ñα╕öα╕úα╕╣α╕¢α╕áα╕▓α╕₧α╣äα╕öα╣ë α╕üα╕úα╕╕α╕ôα╕▓α╕Ñα╕¡α╕çα╣âα╕½α╕íα╣ê');
        } finally {
          setUploadingAvatar(false);
        }
      };

      return (
        <div className="pb-4">
          <header className="sticky top-0 z-20 bg-slate-900/95 backdrop-blur-lg border-b border-slate-800 px-4 py-3 flex items-center justify-between">
            <h1 className="text-base font-semibold">α╣éα╕¢α╕úα╣äα╕ƒα╕Ñα╣î</h1>
            <div className="flex gap-2">
              {!editing ? (
                <>
                  <button onClick={() => setEditing(true)} className="px-3 py-1.5 bg-emerald-600 rounded-lg text-xs">
                    α╣üα╕üα╣ëα╣äα╕é
                  </button>
                  <button onClick={handleLogout} className="px-3 py-1.5 bg-rose-600 hover:bg-rose-700 rounded-lg text-xs">
                    α╕¡α╕¡α╕üα╕êα╕▓α╕üα╕úα╕░α╕Üα╕Ü
                  </button>
                </>
              ) : (
                <>
                  <button onClick={() => { setEditing(false); setForm(user); }} className="px-3 py-1.5 bg-slate-700 rounded-lg text-xs">
                    α╕óα╕üα╣Çα╕Ñα╕┤α╕ü
                  </button>
                  <button onClick={handleSave} className="px-3 py-1.5 bg-emerald-600 rounded-lg text-xs">
                    α╕Üα╕▒α╕Öα╕ùα╕╢α╕ü
                  </button>
                </>
              )}
            </div>
          </header>

          {/* Profile Header */}
          <section className="bg-slate-900/60 border-b border-slate-800">
            <div className="h-24 bg-gradient-to-r from-emerald-600 via-teal-600 to-cyan-600"></div>
            <div className="px-4 pb-4 -mt-12">
              <div className="flex flex-col items-center text-center">
                <div className="relative group">
                  <div className="w-24 h-24 rounded-full border-4 border-slate-900 bg-slate-800 flex items-center justify-center text-3xl overflow-hidden">
                    {user.avatarUrl ? (
                      <img src={user.avatarUrl} alt={user.username} className="w-full h-full object-cover" />
                    ) : (
                      <span>≡ƒæñ</span>
                    )}
                    {uploadingAvatar && (
                      <div className="absolute inset-0 bg-slate-900/80 flex items-center justify-center">
                        <div className="w-8 h-8 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
                      </div>
                    )}
                  </div>
                  {user.isVerified && (
                    <div className="absolute bottom-0 right-0 w-8 h-8 bg-emerald-500 rounded-full border-4 border-slate-900 flex items-center justify-center text-sm">
                      Γ£ô
                    </div>
                  )}
                  {/* Upload button */}
                  <button
                    onClick={() => document.getElementById('avatar-upload-input').click()}
                    disabled={uploadingAvatar}
                    className="absolute -bottom-1 right-0 w-9 h-9 bg-emerald-600 hover:bg-emerald-700 rounded-full border-4 border-slate-900 flex items-center justify-center text-base shadow-lg active:scale-95 transition-transform disabled:opacity-50"
                  >
                    ≡ƒô╖
                  </button>
                  <input
                    id="avatar-upload-input"
                    type="file"
                    accept="image/*"
                    onChange={handleAvatarUpload}
                    className="hidden"
                    disabled={uploadingAvatar}
                  />
                </div>
                <h2 className="text-xl font-bold mt-3">{user.username}</h2>
                <p className="text-sm text-slate-400">{user.worldId}</p>
                <div className="flex flex-col gap-2 mt-2 items-center">
                    {/* Level & Run removed from profile header per UI request */}
                  {user.inviterUsername && (
                    <span className="text-xs text-slate-400">
                      α╕£α╕╣α╣ëα╣üα╕Öα╕░α╕Öα╕│: <span className="text-emerald-400">@{user.inviterUsername}</span>
                    </span>
                  )}
                </div>
              </div>

              {/* Invite Code & Link Section */}
              <div className="px-4 pb-4 space-y-3">
                {/* Invite Code */}
                <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-3">
                  <div className="text-xs text-slate-400 mb-2">α╕úα╕½α╕▒α╕¬α╣Çα╕èα╕┤α╕ìα╣Çα╕₧α╕╖α╣êα╕¡α╕Ö ≡ƒÄü</div>
                  <div className="flex items-center gap-2">
                    <div className="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-3 py-2">
                      <div className="font-mono text-sm text-emerald-300 font-bold">
                        {user.inviteCode || user.worldId}
                      </div>
                    </div>
                    <button
                      onClick={() => {
                        navigator.clipboard.writeText(user.inviteCode || user.worldId);
                        alert('≡ƒôï α╕äα╕▒α╕öα╕Ñα╕¡α╕üα╕úα╕½α╕▒α╕¬α╣Çα╕èα╕┤α╕ìα╣üα╕Ñα╣ëα╕º!');
                      }}
                      className="px-2 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-[10px] font-medium transition-colors whitespace-nowrap"
                    >
                      α╕äα╕▒α╕öα╕Ñα╕¡α╕ü
                    </button>
                  </div>
                </div>

                {/* Invite Link */}
                <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-3">
                  <div className="text-xs text-slate-400 mb-2">α╕Ñα╕┤α╕çα╕üα╣îα╣Çα╕èα╕┤α╕ìα╣Çα╕₧α╕╖α╣êα╕¡α╕Ö ≡ƒöù</div>
                  <div className="flex items-center gap-2">
                    <div className="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-3 py-2">
                      <div className="text-xs text-cyan-300 truncate">
                        {window.location.origin}/register?ref={user.inviteCode || user.worldId}
                      </div>
                    </div>
                    <button
                      onClick={() => {
                        const inviteLink = `${window.location.origin}/register?ref=${user.inviteCode || user.worldId}`;
                        navigator.clipboard.writeText(inviteLink);
                        alert('≡ƒôï α╕äα╕▒α╕öα╕Ñα╕¡α╕üα╕Ñα╕┤α╕çα╕üα╣îα╣Çα╕èα╕┤α╕ìα╣üα╕Ñα╣ëα╕º!');
                      }}
                      className="px-2 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-[10px] font-medium transition-colors whitespace-nowrap"
                    >
                      α╕äα╕▒α╕öα╕Ñα╕¡α╕ü
                    </button>
                  </div>
                </div>

                {/* Share Button */}
                <button
                  onClick={() => {
                    const inviteLink = `${window.location.origin}/register?ref=${user.inviteCode || user.worldId}`;
                    const shareText = `≡ƒÄë α╕íα╕▓α╕úα╣êα╕ºα╕íα╣Çα╕¢α╣çα╕Öα╕¬α╣êα╕ºα╕Öα╕½α╕Öα╕╢α╣êα╕çα╕éα╕¡α╕ç Fingrow α╕üα╕▒α╕Üα╕£α╕í!\n\nΓ£¿ α╕ïα╕╖α╣ëα╕¡α╕éα╕▓α╕óα╕éα╕¡α╕çα╕íα╕╖α╕¡α╕¬α╕¡α╕çα╣äα╕öα╣ëα╕çα╣êα╕▓α╕óα╣å\n≡ƒÆ░ α╕úα╕▒α╕Ü Finpoint α╕êα╕▓α╕üα╕ùα╕╕α╕üα╕üα╕▓α╕úα╕ïα╕╖α╣ëα╕¡α╕éα╕▓α╕ó\n≡ƒÄü α╕¬α╕úα╣ëα╕▓α╕çα╕úα╕▓α╕óα╣äα╕öα╣ëα╕êα╕▓α╕üα╣Çα╕äα╕úα╕╖α╕¡α╕éα╣êα╕▓α╕ó\n\n≡ƒæë α╕Ñα╕çα╕ùα╕░α╣Çα╕Üα╕╡α╕óα╕Öα╕ùα╕╡α╣ê: ${inviteLink}`;

                    if (navigator.share) {
                      navigator.share({
                        title: 'α╣Çα╕èα╕┤α╕ìα╣Çα╕₧α╕╖α╣êα╕¡α╕Öα╣Çα╕éα╣ëα╕▓ Fingrow',
                        text: shareText,
                        url: inviteLink
                      }).catch(() => {});
                    } else {
                      navigator.clipboard.writeText(shareText);
                      alert('≡ƒôï α╕äα╕▒α╕öα╕Ñα╕¡α╕üα╕éα╣ëα╕¡α╕äα╕ºα╕▓α╕íα╣Çα╕èα╕┤α╕ìα╣üα╕Ñα╣ëα╕º!');
                    }
                  }}
                  className="w-full bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white font-medium py-3 rounded-xl transition-all flex items-center justify-center gap-2"
                >
                  <span>≡ƒôñ</span>
                  <span>α╣üα╕èα╕úα╣îα╣Çα╕èα╕┤α╕ìα╣Çα╕₧α╕╖α╣êα╕¡α╕Ö</span>
                </button>
              </div>
            </div>
          </section>

          {/* Info Form */}
          <section className="px-4 pb-4 space-y-3">
            {/* α╕éα╣ëα╕¡α╕íα╕╣α╕Ñα╕¬α╣êα╕ºα╕Öα╕òα╕▒α╕º */}
            <div className="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 space-y-3">
              <h3 className="text-sm font-semibold">α╕éα╣ëα╕¡α╕íα╕╣α╕Ñα╕¬α╣êα╕ºα╕Öα╕òα╕▒α╕º</h3>
              <InputField label="α╕èα╕╖α╣êα╕¡α╕êα╕úα╕┤α╕ç" value={form.firstName || ''}
                onChange={(v) => setForm({...form, firstName: v})} editing={editing} />
              <InputField label="α╕Öα╕▓α╕íα╕¬α╕üα╕╕α╕Ñ" value={form.lastName || ''}
                onChange={(v) => setForm({...form, lastName: v})} editing={editing} />
              <InputField label="α╕¡α╕╡α╣Çα╕íα╕Ñ" value={form.email || ''}
                onChange={(v) => setForm({...form, email: v})} editing={editing} type="email" />
              <InputField label="α╣éα╕ùα╕úα╕¿α╕▒α╕₧α╕ùα╣î" value={form.phone || ''}
                onChange={(v) => setForm({...form, phone: v})} editing={editing} type="tel" />
            </div>

            {/* α╕ùα╕╡α╣êα╕¡α╕óα╕╣α╣ê */}
            <div className="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 space-y-3">
              <h3 className="text-sm font-semibold">α╕ùα╕╡α╣êα╕¡α╕óα╕╣α╣ê</h3>

              {/* α╕Üα╣ëα╕▓α╕Öα╣Çα╕Ñα╕éα╕ùα╕╡α╣ê α╣üα╕Ñα╕░α╕ûα╕Öα╕Ö */}
              <div className="grid grid-cols-2 gap-3">
                <InputField label="α╕Üα╣ëα╕▓α╕Öα╣Çα╕Ñα╕éα╕ùα╕╡α╣ê" value={form.addressNumber || ''}
                  onChange={(v) => setForm({...form, addressNumber: v})} editing={editing}
                  placeholder="123/45" />
                <InputField label="α╕ûα╕Öα╕Ö" value={form.addressStreet || ''}
                  onChange={(v) => setForm({...form, addressStreet: v})} editing={editing}
                  placeholder="α╕¬α╕╕α╕éα╕╕α╕íα╕ºα╕┤α╕ù" />
              </div>

              {/* α╣üα╕éα╕ºα╕ç/α╕òα╕│α╕Üα╕Ñ α╣üα╕Ñα╕░α╣Çα╕éα╕ò/α╕¡α╕│α╣Çα╕áα╕¡ */}
              <div className="grid grid-cols-2 gap-3">
                <InputField label="α╣üα╕éα╕ºα╕ç/α╕òα╕│α╕Üα╕Ñ" value={form.addressSubDistrict || ''}
                  onChange={(v) => setForm({...form, addressSubDistrict: v})} editing={editing}
                  placeholder="α╕äα╕Ñα╕¡α╕çα╣Çα╕òα╕ó" />
                <InputField label="α╣Çα╕éα╕ò/α╕¡α╕│α╣Çα╕áα╕¡" value={form.addressDistrict || ''}
                  onChange={(v) => setForm({...form, addressDistrict: v})} editing={editing}
                  placeholder="α╕äα╕Ñα╕¡α╕çα╣Çα╕òα╕ó" />
              </div>

              {/* α╕êα╕▒α╕çα╕½α╕ºα╕▒α╕ö α╣üα╕Ñα╕░α╕úα╕½α╕▒α╕¬α╣äα╕¢α╕úα╕⌐α╕ôα╕╡α╕óα╣î */}
              <div className="grid grid-cols-2 gap-3">
                <InputField label="α╕êα╕▒α╕çα╕½α╕ºα╕▒α╕ö" value={form.addressProvince || ''}
                  onChange={(v) => setForm({...form, addressProvince: v})} editing={editing}
                  placeholder="α╕üα╕úα╕╕α╕çα╣Çα╕ùα╕₧α╕íα╕½α╕▓α╕Öα╕äα╕ú" />
                <InputField label="α╕úα╕½α╕▒α╕¬α╣äα╕¢α╕úα╕⌐α╕ôα╕╡α╕óα╣î" value={form.addressPostalCode || ''}
                  onChange={(v) => setForm({...form, addressPostalCode: v})} editing={editing}
                  type="tel" maxLength={5} placeholder="10110" />
              </div>
            </div>
          </section>
        </div>
      );
    }

    // Helper Components
    function ExpCard({ exp, selectedProducts = [], onSettingsClick, onOpenDemoFinpoint, userId, currentFpBalance, purchasedProductIds = [], onPurchaseComplete }) {
      const [isExpanded, setIsExpanded] = React.useState(false);
      const [showPurchaseModal, setShowPurchaseModal] = React.useState(false);
      const [selectedProduct, setSelectedProduct] = React.useState(null);
      const [showDuplicateWarning, setShowDuplicateWarning] = React.useState(false);
      const percent = exp.target > 0 ? Math.min(100, Math.round((exp.current / exp.target) * 100)) : 0;
      const canUse = exp.current >= exp.target;

      // Calculate Finpoint summary
      const totalRequiredFP = selectedProducts.reduce((sum, product) => sum + parseFloat(product.premiumTotal), 0);
      const haveFP = exp.current;
      const needFP = totalRequiredFP;
      const missingFP = Math.max(0, totalRequiredFP - haveFP); // FP that is missing to complete this level

      const handlePurchaseInsurance = (product, currentBalance) => {
        const finpointPrice = parseFloat(product.finpointPrice || product.premiumTotal);
        const missingFP = Math.max(0, finpointPrice - currentBalance);
        const productId = product.insuranceProductId || product.id;
        const isPurchased = purchasedProductIds.includes(productId);

        setSelectedProduct({ ...product, currentBalance, finpointPrice, missingFP, isPurchased });

        // If already purchased, show duplicate warning
        if (isPurchased) {
          setShowDuplicateWarning(true);
        } else {
          setShowPurchaseModal(true);
        }
      };

      const confirmPurchase = async () => {
        if (!selectedProduct) return;

        // Check if user has enough FP
        if (selectedProduct.missingFP > 0) {
          // Not enough FP - close modal, user needs to add FP via Demo button
          setShowPurchaseModal(false);
          setSelectedProduct(null);
          return;
        }

        try {
          // Get product ID - the selection object has insuranceProductId at the root level
          const productId = selectedProduct.insuranceProductId || selectedProduct.id || selectedProduct.productId;

          if (!productId) {
            console.error('No product ID found in selectedProduct:', selectedProduct);
            alert('Γ¥î α╕éα╣ëα╕¡α╕íα╕╣α╕Ñα╕¬α╕┤α╕Öα╕äα╣ëα╕▓α╣äα╕íα╣êα╕äα╕úα╕Üα╕ûα╣ëα╕ºα╕Ö α╕üα╕úα╕╕α╕ôα╕▓α╕Ñα╕¡α╕çα╣âα╕½α╕íα╣êα╕¡α╕╡α╕üα╕äα╕úα╕▒α╣ëα╕ç');
            setShowPurchaseModal(false);
            setSelectedProduct(null);
            return;
          }

          // Call purchase API
          const response = await fetch(`${API_BASE}/api/insurance/purchase`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              userId: userId,
              insuranceProductId: productId
            })
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error || 'Purchase failed');
          }

          // Success - show success message
          alert(`Γ£à α╕ïα╕╖α╣ëα╕¡α╕¢α╕úα╕░α╕üα╕▒α╕Öα╕¬α╕│α╣Çα╕úα╣çα╕ê!\n\n` +
                `α╕úα╕▓α╕óα╕üα╕▓α╕ú: ${selectedProduct.title}\n` +
                `α╣âα╕èα╣ë Finpoint: ${result.data.finpointSpent.toLocaleString('th-TH', {minimumFractionDigits: 2})} FP\n` +
                `α╕äα╕çα╣Çα╕½α╕Ñα╕╖α╕¡: ${result.data.newBalance.toLocaleString('th-TH', {minimumFractionDigits: 2})} FP`);

          // Close modal
          setShowPurchaseModal(false);
          setSelectedProduct(null);

          // Refresh data via callback
          if (onPurchaseComplete) {
            onPurchaseComplete();
          }
        } catch (error) {
          console.error('Error purchasing insurance:', error);
          alert('Γ¥î α╣Çα╕üα╕┤α╕öα╕éα╣ëα╕¡α╕£α╕┤α╕öα╕₧α╕Ñα╕▓α╕öα╣âα╕Öα╕üα╕▓α╕úα╕ïα╕╖α╣ëα╕¡α╕¢α╕úα╕░α╕üα╕▒α╕Ö: ' + error.message);
        }
      };

      return (
        <div className="bg-slate-900/60 border border-slate-800 rounded-xl p-4">
          {/* Header with level and controls */}
          <div className="flex items-center justify-between mb-3">
            <h4 className="text-sm font-medium">{exp.label}</h4>
            <div className="flex items-center gap-2">
              {selectedProducts.length > 0 && (
                <button
                  onClick={() => setIsExpanded(!isExpanded)}
                  className="text-xs text-cyan-400 hover:text-cyan-300 transition-colors flex items-center gap-1"
                >
                  {isExpanded ? 'Γû╝ α╕óα╣êα╕¡' : `α╕öα╕╣α╕úα╕▓α╕óα╕Ñα╕░α╣Çα╕¡α╕╡α╕óα╕ö (${selectedProducts.length})`}
                </button>
              )}
              <span className="text-xs text-slate-400">{percent}%</span>
              <button
                onClick={() => onSettingsClick(exp)}
                className="w-6 h-6 rounded-lg bg-slate-800 hover:bg-slate-700 flex items-center justify-center text-xs transition-colors"
                title="α╕òα╕▒α╣ëα╕çα╕äα╣êα╕▓α╣üα╕£α╕Öα╕¢α╕úα╕░α╕üα╕▒α╕Ö"
              >
                ΓÜÖ∩╕Å
              </button>
            </div>
          </div>

          {/* Status bar - progress from total calculation */}
          <div className="w-full h-2 rounded-full bg-slate-800 overflow-hidden mb-3">
            <div className="h-full bg-emerald-400 transition-all" style={{ width: `${percent}%` }}></div>
          </div>

          {/* FP summary on the right side */}
          <div className="flex items-center justify-end mb-3 text-xs">
            <span className="text-slate-400">α╕äα╕╕α╕ôα╕íα╕╡</span>
            <span className="font-semibold text-emerald-300 ml-1">{haveFP.toLocaleString()}</span>
            <span className="text-slate-400 mx-1">FP | α╕òα╣ëα╕¡α╕çα╣âα╕èα╣ë</span>
            <span className="font-semibold text-amber-300">{needFP.toLocaleString()}</span>
            <span className="text-slate-400 mx-1">FP α╕óα╕▒α╕çα╕éα╕▓α╕ö</span>
            <span className="font-semibold text-red-300">{missingFP.toLocaleString()}</span>
            <span className="text-slate-400 ml-1">FP</span>
          </div>

          {/* Collapsible insurance details */}
          {isExpanded && selectedProducts.length > 0 && (
            <div className="space-y-2 mb-3">
              {selectedProducts.map((product, idx) => {
                if (!product) return null;

                const finpointPrice = parseFloat(product.finpointPrice || product.premiumTotal);
                const premiumBaht = parseFloat(product.premiumTotal);
                const missingFP = Math.max(0, finpointPrice - exp.current);
                const hasEnough = exp.current >= finpointPrice;

                return (
                <div key={idx} className="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50">
                  <div className="flex items-start justify-between gap-2 mb-2">
                    <div className="flex-1 min-w-0">
                      <div className="text-xs font-medium text-slate-200 truncate">{product.shortTitle}</div>
                      <div className="text-[10px] text-slate-400">{product.insurerCompanyName}</div>
                      <div className="text-[10px] text-slate-300 mt-1">α╕úα╕▓α╕äα╕▓ {premiumBaht.toLocaleString()} α╕Üα╕▓α╕ù</div>
                    </div>
                    <div className="text-right flex-shrink-0">
                      <div className="text-base font-bold text-amber-400">{finpointPrice.toLocaleString()} FP</div>
                    </div>
                  </div>

                  {/* Status message */}
                  <div className={`text-xs mb-2 ${hasEnough ? 'text-emerald-400' : 'text-orange-400'}`}>
                    {hasEnough ? 'Γ£ô α╕äα╕╕α╕ôα╕íα╕╡ Finpoint α╣Çα╕₧α╕╡α╕óα╕çα╕₧α╕¡' : `ΓÜá α╕óα╕▒α╕çα╕éα╕▓α╕ö ${missingFP.toLocaleString()} FP`}
                  </div>

                  {/* Progress bar */}
                  <div className="w-full h-1.5 rounded-full bg-slate-700 overflow-hidden mb-2">
                    <div
                      className="h-full bg-gradient-to-r from-emerald-500 to-cyan-500 transition-all"
                      style={{ width: `${Math.min(100, (exp.current / finpointPrice) * 100)}%` }}
                    ></div>
                  </div>

                  <div className="flex items-center justify-end">
                    {(() => {
                      const productId = product.insuranceProductId || product.id;
                      const isPurchased = purchasedProductIds.includes(productId);
                      return (
                        <button
                          onClick={() => handlePurchaseInsurance(product, currentFpBalance)}
                          className={`text-xs ${isPurchased ? 'bg-slate-600 hover:bg-slate-500' : 'bg-emerald-600 hover:bg-emerald-700'} text-white px-3 py-1.5 rounded transition-colors`}
                        >
                          {isPurchased ? 'α╕ïα╕╖α╣ëα╕¡α╣üα╕Ñα╣ëα╕º (α╕ïα╕╖α╣ëα╕¡α╕ïα╣ëα╕│?)' : 'α╕ïα╕╖α╣ëα╕¡ (α╕úα╕░α╕Üα╕Üα╕ùα╕öα╕¬α╕¡α╕Ü)'}
                        </button>
                      );
                    })()}
                  </div>
                </div>
                );
              })}
            </div>
          )}

          {/* Purchase Confirmation Modal */}
          {showPurchaseModal && selectedProduct && (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
              <div className="bg-slate-900 border border-slate-700 rounded-2xl p-6 max-w-md w-full">
                <h3 className="text-lg font-semibold mb-4 text-center">
                  {selectedProduct.missingFP > 0 ? 'Finpoint α╣äα╕íα╣êα╣Çα╕₧α╕╡α╕óα╕çα╕₧α╕¡' : 'α╕óα╕╖α╕Öα╕óα╕▒α╕Öα╕üα╕▓α╕úα╕ïα╕╖α╣ëα╕¡α╕¢α╕úα╕░α╕üα╕▒α╕Ö'}
                </h3>

                <div className="bg-slate-800/50 rounded-lg p-4 mb-4">
                  <div className="text-sm text-slate-300 mb-2">{selectedProduct.shortTitle}</div>
                  <div className="text-xs text-slate-400 mb-3">{selectedProduct.insurerCompanyName}</div>
                  <div className="text-amber-400 text-lg font-bold text-center">{selectedProduct.finpointPrice.toLocaleString()} FP</div>
                </div>

                {selectedProduct.missingFP > 0 ? (
                  // Not enough FP
                  <>
                    <div className="bg-red-900/20 border border-red-700/50 rounded-lg p-4 mb-6">
                      <div className="text-red-400 text-sm text-center mb-2">
                        ΓÜá∩╕Å α╕óα╕▒α╕çα╕éα╕▓α╕öα╕¡α╕╡α╕ü <span className="font-bold text-lg">{selectedProduct.missingFP.toLocaleString()}</span> FP
                      </div>
                      <div className="text-slate-400 text-xs text-center">
                        α╣éα╕¢α╕úα╕öα╣Çα╕òα╕┤α╕í Finpoint
                      </div>
                    </div>

                    <div className="flex gap-3">
                      <button
                        onClick={() => {
                          setShowPurchaseModal(false);
                          setSelectedProduct(null);
                        }}
                        className="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2.5 rounded-lg transition-colors"
                      >
                        α╕óα╕üα╣Çα╕Ñα╕┤α╕ü
                      </button>
                      <button
                        onClick={() => {
                          setShowPurchaseModal(false);
                          setSelectedProduct(null);
                          // Call parent function to open demo finpoint modal
                          if (onOpenDemoFinpoint) {
                            onOpenDemoFinpoint(selectedProduct.missingFP);
                          }
                        }}
                        className="flex-1 bg-cyan-600 hover:bg-cyan-700 text-white py-2.5 rounded-lg transition-colors font-medium"
                      >
                        ≡ƒÆ│ α╕úα╕▒α╕Ü Finpoint (Demo)
                      </button>
                    </div>
                  </>
                ) : (
                  // Enough FP
                  <>
                    <div className="bg-amber-900/20 border border-amber-700/50 rounded-lg p-3 mb-6">
                      <div className="text-amber-400 text-sm text-center">
                        ΓÜá∩╕Å α╣Çα╕¢α╣çα╕Öα╣Çα╕₧α╕╡α╕óα╕çα╕úα╕░α╕Üα╕Üα╕üα╕▓α╕úα╕ùα╕öα╕¬α╕¡α╕Üα╕üα╕▓α╕úα╕úα╕▒α╕Öα╕ïα╕╖α╣ëα╕¡α╣Çα╕ùα╣êα╕▓α╕Öα╕▒α╣ëα╕Ö
                      </div>
                    </div>

                    <div className="flex gap-3">
                      <button
                        onClick={() => {
                          setShowPurchaseModal(false);
                          setSelectedProduct(null);
                        }}
                        className="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2.5 rounded-lg transition-colors"
                      >
                        α╕óα╕üα╣Çα╕Ñα╕┤α╕ü
                      </button>
                      <button
                        onClick={confirmPurchase}
                        className="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-2.5 rounded-lg transition-colors font-medium"
                      >
                        α╕óα╕╖α╕Öα╕óα╕▒α╕Ö
                      </button>
                    </div>
                  </>
                )}
              </div>
            </div>
          )}

          {/* Duplicate Purchase Warning Modal */}
          {showDuplicateWarning && selectedProduct && (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
              <div className="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-md overflow-hidden">
                {/* Header */}
                <div className="px-5 py-4 border-b border-slate-800">
                  <h3 className="text-lg font-semibold text-amber-400">ΓÜá∩╕Å α╕äα╕╕α╕ôα╣äα╕öα╣ëα╕ïα╕╖α╣ëα╕¡α╕¢α╕úα╕░α╕üα╕▒α╕Öα╕Öα╕╡α╣ëα╣üα╕Ñα╣ëα╕º</h3>
                </div>

                {/* Content */}
                <div className="p-5">
                  <div className="mb-4">
                    <p className="text-slate-300 mb-2">
                      α╕äα╕╕α╕ôα╣äα╕öα╣ëα╕ïα╕╖α╣ëα╕¡α╕¢α╕úα╕░α╕üα╕▒α╕Ö <span className="font-medium text-white">{selectedProduct.title}</span> α╣äα╕¢α╣üα╕Ñα╣ëα╕º
                    </p>
                    <p className="text-slate-400 text-sm">
                      α╕òα╣ëα╕¡α╕çα╕üα╕▓α╕úα╕ïα╕╖α╣ëα╕¡α╕ïα╣ëα╕│α╣âα╕èα╣êα╕½α╕úα╕╖α╕¡α╣äα╕íα╣ê? (α╕üα╕úα╕ôα╕╡α╕íα╕╡α╕úα╕ûα╕½α╕Ñα╕▓α╕óα╕äα╕▒α╕Ö α╕½α╕úα╕╖α╕¡α╕òα╣ëα╕¡α╕çα╕üα╕▓α╕úα╕äα╕ºα╕▓α╕íα╕äα╕╕α╣ëα╕íα╕äα╕úα╕¡α╕çα╣Çα╕₧α╕┤α╣êα╕íα╣Çα╕òα╕┤α╕í)
                    </p>
                  </div>

                  <div className="flex gap-3">
                    <button
                      onClick={() => {
                        setShowDuplicateWarning(false);
                        setSelectedProduct(null);
                      }}
                      className="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2.5 rounded-lg transition-colors"
                    >
                      α╕óα╕üα╣Çα╕Ñα╕┤α╕ü
                    </button>
                    <button
                      onClick={() => {
                        setShowDuplicateWarning(false);
                        setShowPurchaseModal(true);
                      }}
                      className="flex-1 bg-amber-600 hover:bg-amber-700 text-white py-2.5 rounded-lg transition-colors font-medium"
                    >
                      α╕óα╕╖α╕Öα╕óα╕▒α╕Öα╕ïα╕╖α╣ëα╕¡α╕ïα╣ëα╕│
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function InputField({ label, value, onChange, editing, type = "text", placeholder = "", maxLength }) {
      return (
        <div>
          <label className="block text-xs text-slate-400 mb-2">{label}</label>
          {editing ? (
            <input
              type={type}
              value={value || ""}
              onChange={(e) => onChange(e.target.value)}
              placeholder={placeholder}
              maxLength={maxLength}
              className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm focus:outline-none focus:border-emerald-500 placeholder:text-slate-500"
            />
          ) : (
            <div className="px-3 py-2 text-sm text-slate-200">{value || '-'}</div>
          )}
        </div>
      );
    }

    // Database Viewer Component
    function DatabaseViewer() {
      const [tables, setTables] = React.useState([]);
      const [selectedTable, setSelectedTable] = React.useState('');
      const [tableData, setTableData] = React.useState(null);
      const [isLoadingTables, setIsLoadingTables] = React.useState(false);
      const [isLoadingData, setIsLoadingData] = React.useState(false);

      // Fetch tables list
      const fetchTables = async () => {
        try {
          setIsLoadingTables(true);
          const response = await fetch(`${API_BASE}/api/database/tables`);
          if (response.ok) {
            const data = await response.json();
            setTables(data.tables || []);
          }
        } catch (error) {
          console.error('Error fetching tables:', error);
        } finally {
          setIsLoadingTables(false);
        }
      };

      // Fetch table data
      const fetchTableData = async (tableName) => {
        if (!tableName) return;

        try {
          setIsLoadingData(true);
          const response = await fetch(`${API_BASE}/api/database/tables/${tableName}?limit=50`);
          if (response.ok) {
            const data = await response.json();
            setTableData(data);
          }
        } catch (error) {
          console.error('Error fetching table data:', error);
        } finally {
          setIsLoadingData(false);
        }
      };

      // Load tables on mount
      React.useEffect(() => {
        fetchTables();
      }, []);

      // Fetch data when table is selected
      React.useEffect(() => {
        if (selectedTable) {
          fetchTableData(selectedTable);
        }
      }, [selectedTable]);

      return (
        <div className="pb-4">
          {/* Header */}
          <header className="sticky top-0 z-20 bg-slate-900/95 backdrop-blur-lg border-b border-slate-800">
            <div className="px-4 py-3">
              <h1 className="text-base font-semibold">≡ƒùä∩╕Å Database Viewer</h1>
              <p className="text-xs text-slate-400 mt-1">α╕öα╕╣α╕éα╣ëα╕¡α╕íα╕╣α╕Ñα╕òα╕▓α╕úα╕▓α╕çα╕Éα╕▓α╕Öα╕éα╣ëα╕¡α╕íα╕╣α╕Ñ PostgreSQL</p>
            </div>
          </header>

          {/* Tables List */}
          <section className="p-4">
            <div className="mb-4">
              <label className="block text-sm font-medium mb-2">α╣Çα╕Ñα╕╖α╕¡α╕üα╕òα╕▓α╕úα╕▓α╕ç:</label>
              {isLoadingTables ? (
                <div className="bg-slate-800 border border-slate-700 rounded-lg p-4 text-center">
                  <div className="text-sm text-slate-400">α╕üα╕│α╕Ñα╕▒α╕çα╣éα╕½α╕Ñα╕öα╕úα╕▓α╕óα╕üα╕▓α╕úα╕òα╕▓α╕úα╕▓α╕ç...</div>
                </div>
              ) : (
                <select
                  value={selectedTable}
                  onChange={(e) => setSelectedTable(e.target.value)}
                  className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
                >
                  <option value="">-- α╣Çα╕Ñα╕╖α╕¡α╕üα╕òα╕▓α╕úα╕▓α╕ç --</option>
                  {tables.map((table) => (
                    <option key={table.table_name} value={table.table_name}>
                      {table.table_name} ({table.column_count} columns)
                    </option>
                  ))}
                </select>
              )}
            </div>

            {/* Quick Links */}
            <div className="grid grid-cols-2 gap-2 mb-4">
              <button
                onClick={() => window.open(`${API_BASE}/api/database/tables`, '_blank')}
                className="px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-xs font-medium transition-colors"
              >
                ≡ƒôï API Tables List
              </button>
              <button
                onClick={() => window.open(`${API_BASE}/api/database/users/all`, '_blank')}
                className="px-3 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-xs font-medium transition-colors"
              >
                ≡ƒæÑ All Users
              </button>
            </div>
          </section>

          {/* Table Data */}
          {selectedTable && (
            <section className="px-4">
              {isLoadingData ? (
                <div className="bg-slate-800 border border-slate-700 rounded-lg p-4 text-center">
                  <div className="text-sm text-slate-400">α╕üα╕│α╕Ñα╕▒α╕çα╣éα╕½α╕Ñα╕öα╕éα╣ëα╕¡α╕íα╕╣α╕Ñα╕òα╕▓α╕úα╕▓α╕ç...</div>
                </div>
              ) : tableData ? (
                <div className="bg-slate-800 border border-slate-700 rounded-lg overflow-hidden">
                  {/* Table Info */}
                  <div className="px-4 py-3 bg-slate-900/60 border-b border-slate-700">
                    <h3 className="text-sm font-semibold flex items-center gap-2">
                      ≡ƒôè Table: {tableData.tableName}
                    </h3>
                    <div className="text-xs text-slate-400 mt-1">
                      Total rows: {tableData.total.toLocaleString()} |
                      Showing: {tableData.offset}-{Math.min(tableData.offset + tableData.limit, tableData.total)}
                    </div>
                  </div>

                  {/* Table Content */}
                  <div className="overflow-x-auto max-h-96">
                    <table className="w-full text-xs">
                      <thead className="sticky top-0 bg-slate-900">
                        <tr>
                          {tableData.columns.map((col) => (
                            <th key={col.column_name} className="px-3 py-2 text-left font-medium text-slate-300 border-b border-slate-700">
                              <div>
                                <div>{col.column_name}</div>
                                <div className="text-[9px] text-slate-500">{col.data_type}</div>
                              </div>
                            </th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {tableData.data.map((row, idx) => (
                          <tr key={idx} className="hover:bg-slate-700/30">
                            {tableData.columns.map((col) => (
                              <td key={col.column_name} className="px-3 py-2 border-t border-slate-800 text-slate-200">
                                {row[col.column_name] !== null ? String(row[col.column_name]) : '-'}
                              </td>
                            ))}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>

                  {/* Pagination Info */}
                  <div className="px-4 py-3 bg-slate-900/60 border-t border-slate-700 text-xs text-slate-400">
                    <div className="flex items-center justify-between">
                      <span>
                        {tableData.data.length} of {tableData.total} rows
                      </span>
                      {tableData.offset > 0 && (
                        <button
                          onClick={() => fetchTableData(selectedTable)}
                          className="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs"
                        >
                          Refresh
                        </button>
                      )}
                    </div>
                  </div>
                </div>
              ) : (
                <div className="bg-slate-800 border border-slate-700 rounded-lg p-4 text-center">
                  <div className="text-sm text-slate-400">α╣äα╕íα╣êα╕₧α╕Üα╕éα╣ëα╕¡α╕íα╕╣α╕Ñα╕òα╕▓α╕úα╕▓α╕ç</div>
                </div>
              )}
            </section>
          )}

          {/* Info Section */}
          <section className="px-4 pb-4 mt-4">
            <div className="bg-slate-900/40 border border-slate-800 rounded-xl p-3">
              <div className="flex items-start gap-2">
                <div className="text-slate-400 mt-0.5">Γä╣∩╕Å</div>
                <div className="flex-1">
                  <div className="text-xs text-slate-400 leading-relaxed">
                    <div className="mb-1">ΓÇó α╣Çα╕Ñα╕╖α╕¡α╕üα╕òα╕▓α╕úα╕▓α╕çα╣Çα╕₧α╕╖α╣êα╕¡α╕öα╕╣α╕éα╣ëα╕¡α╕íα╕╣α╕Ñα╕êα╕▓α╕üα╕Éα╕▓α╕Öα╕éα╣ëα╕¡α╕íα╕╣α╕Ñα╕êα╕úα╕┤α╕ç</div>
                    <div className="mb-1">ΓÇó α╕éα╣ëα╕¡α╕íα╕╣α╕Ñα╕êα╕░α╕ûα╕╣α╕üα╕öα╕╢α╕çα╕êα╕▓α╕ü PostgreSQL Server α╣éα╕öα╕óα╕òα╕úα╕ç</div>
                    <div>ΓÇó α╕êα╕│α╕üα╕▒α╕öα╕üα╕▓α╕úα╣üα╕¬α╕öα╕çα╕£α╕Ñ 50 α╣üα╕ûα╕ºα╕òα╣êα╕¡α╕äα╕úα╕▒α╣ëα╕ç</div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>
      );
    }

    // Bottom Navigation
    function BottomNav({ currentPage, setCurrentPage, unreadNotificationCount }) {
      const navItems = [
        { id: 'home', icon: '≡ƒÅá', label: 'Home' },
        { id: 'transactions', icon: '≡ƒôï', label: 'α╕úα╕▓α╕óα╕üα╕▓α╕ú' },
        { id: 'tree', icon: '≡ƒò╕∩╕Å', label: 'Tree' },
        { id: 'acf', icon: '≡ƒöù', label: 'ACF' },
        { id: 'notifications', icon: '≡ƒöö', label: 'α╣üα╕êα╣ëα╕çα╣Çα╕òα╕╖α╕¡α╕Ö' },
        { id: 'profile', icon: '≡ƒæñ', label: 'Profile' },
      ];

      return (
        <nav className="fixed bottom-0 left-0 right-0 z-30 bg-slate-900/95 backdrop-blur-lg border-t border-slate-800 bottom-nav-safe">
          <div className="flex items-center justify-around px-2 py-2">
            {navItems.map((item) => (
              <button
                key={item.id}
                onClick={() => setCurrentPage(item.id)}
                className={`flex flex-col items-center justify-center flex-1 py-2 rounded-lg transition-colors ${
                  currentPage === item.id
                    ? 'text-emerald-300'
                    : 'text-slate-400 hover:text-slate-200'
                }`}
              >
                <span className="relative text-xl mb-0.5">
                  {item.icon}
                  {item.id === 'notifications' && unreadNotificationCount > 0 && (
                    <span className="absolute -top-2 -right-3 min-w-[18px] h-[18px] px-1 flex items-center justify-center bg-amber-400 text-black text-[11px] font-bold rounded-full ring-2 ring-slate-900">
                      {unreadNotificationCount > 99 ? '99+' : unreadNotificationCount}
                    </span>
                  )}
                </span>
                <span className="text-xs font-medium">{item.label}</span>
                {currentPage === item.id && (
                  <div className="w-1 h-1 bg-emerald-400 rounded-full mt-1"></div>
                )}
              </button>
            ))}
          </div>
        </nav>
      );
    }

    // Render
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
